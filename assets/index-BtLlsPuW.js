import{C as zt,V as S,M as de,T as fe,Q as H,S as gt,a as K,R as Wt,P as qt,b as Oe,c as Ht,O as Ge,d as re,L as We,e as $,B as V,f as ze,F as yt,g as E,h as je,i as ie,j as Me,k as Qt,E as Jt,l as Ee,m as Ke,D as X,n as es,o as ht,p as jt,q as Bt,r as De,s as qe,t as ae,u as te,v as ne,w as Z,x as ts,y as ss,z as dt,I as ns,A as os,G as _e,H as is,J as Ne,K as rs,N as Qe,U as as,W as cs,X as ls,Y as He,Z as me,_ as he,$ as hs,a0 as ds,a1 as us,a2 as Je,a3 as xe,a4 as ps,a5 as ms,a6 as Ut,a7 as fs,a8 as gs,a9 as Fe,aa as $t,ab as ys,ac as ws,ad as bs,ae as _s,af as xs,ag as Vt,ah as Ss,ai as wt,aj as bt,ak as _t,al as xt,am as ut,an as Es,ao as Ts,ap as ve,aq as Ms,ar as As,as as Be,at as et,au as Ue,av as tt,aw as Ps,ax as Rs,ay as Ls,az as Cs,aA as vs,aB as Q,aC as Ae,aD as St,aE as Pe,aF as Et,aG as Is,aH as ks,aI as Os,aJ as Ds,aK as st,aL as Tt,aM as Ns}from"./three-Bwsh22it.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const Mt={type:"change"},ft={type:"start"},Xt={type:"end"},$e=new Wt,At=new qt,Fs=Math.cos(70*Oe.DEG2RAD),B=new S,J=2*Math.PI,D={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},nt=1e-6;class Gs extends zt{constructor(e,t=null){super(e,t),this.state=D.NONE,this.enabled=!0,this.target=new S,this.cursor=new S,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:de.ROTATE,MIDDLE:de.DOLLY,RIGHT:de.PAN},this.touches={ONE:fe.ROTATE,TWO:fe.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new S,this._lastQuaternion=new H,this._lastTargetPosition=new S,this._quat=new H().setFromUnitVectors(e.up,new S(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new gt,this._sphericalDelta=new gt,this._scale=1,this._panOffset=new S,this._rotateStart=new K,this._rotateEnd=new K,this._rotateDelta=new K,this._panStart=new K,this._panEnd=new K,this._panDelta=new K,this._dollyStart=new K,this._dollyEnd=new K,this._dollyDelta=new K,this._dollyDirection=new S,this._mouse=new K,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=Hs.bind(this),this._onPointerDown=zs.bind(this),this._onPointerUp=js.bind(this),this._onContextMenu=Ks.bind(this),this._onMouseWheel=$s.bind(this),this._onKeyDown=Vs.bind(this),this._onTouchStart=Xs.bind(this),this._onTouchMove=Ys.bind(this),this._onMouseDown=Bs.bind(this),this._onMouseMove=Us.bind(this),this._interceptControlDown=Zs.bind(this),this._interceptControlUp=Ws.bind(this),this.domElement!==null&&this.connect(),this.update()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(Mt),this.update(),this.state=D.NONE}update(e=null){const t=this.object.position;B.copy(t).sub(this.target),B.applyQuaternion(this._quat),this._spherical.setFromVector3(B),this.autoRotate&&this.state===D.NONE&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let n=this.minAzimuthAngle,s=this.maxAzimuthAngle;isFinite(n)&&isFinite(s)&&(n<-Math.PI?n+=J:n>Math.PI&&(n-=J),s<-Math.PI?s+=J:s>Math.PI&&(s-=J),n<=s?this._spherical.theta=Math.max(n,Math.min(s,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(n+s)/2?Math.max(n,this._spherical.theta):Math.min(s,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let i=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const o=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),i=o!=this._spherical.radius}if(B.setFromSpherical(this._spherical),B.applyQuaternion(this._quatInverse),t.copy(this.target).add(B),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let o=null;if(this.object.isPerspectiveCamera){const r=B.length();o=this._clampDistance(r*this._scale);const a=r-o;this.object.position.addScaledVector(this._dollyDirection,a),this.object.updateMatrixWorld(),i=!!a}else if(this.object.isOrthographicCamera){const r=new S(this._mouse.x,this._mouse.y,0);r.unproject(this.object);const a=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),i=a!==this.object.zoom;const c=new S(this._mouse.x,this._mouse.y,0);c.unproject(this.object),this.object.position.sub(c).add(r),this.object.updateMatrixWorld(),o=B.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;o!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(o).add(this.object.position):($e.origin.copy(this.object.position),$e.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot($e.direction))<Fs?this.object.lookAt(this.target):(At.setFromNormalAndCoplanarPoint(this.object.up,this.target),$e.intersectPlane(At,this.target))))}else if(this.object.isOrthographicCamera){const o=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),o!==this.object.zoom&&(this.object.updateProjectionMatrix(),i=!0)}return this._scale=1,this._performCursorZoom=!1,i||this._lastPosition.distanceToSquared(this.object.position)>nt||8*(1-this._lastQuaternion.dot(this.object.quaternion))>nt||this._lastTargetPosition.distanceToSquared(this.target)>nt?(this.dispatchEvent(Mt),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(e){return e!==null?J/60*this.autoRotateSpeed*e:J/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(e*.01);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){B.setFromMatrixColumn(t,0),B.multiplyScalar(-e),this._panOffset.add(B)}_panUp(e,t){this.screenSpacePanning===!0?B.setFromMatrixColumn(t,1):(B.setFromMatrixColumn(t,0),B.crossVectors(this.object.up,B)),B.multiplyScalar(e),this._panOffset.add(B)}_pan(e,t){const n=this.domElement;if(this.object.isPerspectiveCamera){const s=this.object.position;B.copy(s).sub(this.target);let i=B.length();i*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*i/n.clientHeight,this.object.matrix),this._panUp(2*t*i/n.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/n.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/n.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const n=this.domElement.getBoundingClientRect(),s=e-n.left,i=t-n.top,o=n.width,r=n.height;this._mouse.x=s/o*2-1,this._mouse.y=-(i/r)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(J*this._rotateDelta.x/t.clientHeight),this._rotateUp(J*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this._rotateUp(J*this.rotateSpeed/this.domElement.clientHeight):this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this._rotateUp(-J*this.rotateSpeed/this.domElement.clientHeight):this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this._rotateLeft(J*this.rotateSpeed/this.domElement.clientHeight):this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this._rotateLeft(-J*this.rotateSpeed/this.domElement.clientHeight):this._pan(-this.keyPanSpeed,0),t=!0;break}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(this._pointers.length===1)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);this._rotateStart.set(n,s)}}_handleTouchStartPan(e){if(this._pointers.length===1)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);this._panStart.set(n,s)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),n=e.pageX-t.x,s=e.pageY-t.y,i=Math.sqrt(n*n+s*s);this._dollyStart.set(0,i)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(this._pointers.length==1)this._rotateEnd.set(e.pageX,e.pageY);else{const n=this._getSecondPointerPosition(e),s=.5*(e.pageX+n.x),i=.5*(e.pageY+n.y);this._rotateEnd.set(s,i)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(J*this._rotateDelta.x/t.clientHeight),this._rotateUp(J*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(this._pointers.length===1)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);this._panEnd.set(n,s)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),n=e.pageX-t.x,s=e.pageY-t.y,i=Math.sqrt(n*n+s*s);this._dollyEnd.set(0,i),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const o=(e.pageX+t.x)*.5,r=(e.pageY+t.y)*.5;this._updateZoomParameters(o,r)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId){this._pointers.splice(t,1);return}}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];t===void 0&&(t=new K,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,n={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:n.deltaY*=16;break;case 2:n.deltaY*=100;break}return e.ctrlKey&&!this._controlActive&&(n.deltaY*=10),n}}function zs(u){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(u.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(u)&&(this._addPointer(u),u.pointerType==="touch"?this._onTouchStart(u):this._onMouseDown(u)))}function Hs(u){this.enabled!==!1&&(u.pointerType==="touch"?this._onTouchMove(u):this._onMouseMove(u))}function js(u){switch(this._removePointer(u),this._pointers.length){case 0:this.domElement.releasePointerCapture(u.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(Xt),this.state=D.NONE;break;case 1:const e=this._pointers[0],t=this._pointerPositions[e];this._onTouchStart({pointerId:e,pageX:t.x,pageY:t.y});break}}function Bs(u){let e;switch(u.button){case 0:e=this.mouseButtons.LEFT;break;case 1:e=this.mouseButtons.MIDDLE;break;case 2:e=this.mouseButtons.RIGHT;break;default:e=-1}switch(e){case de.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(u),this.state=D.DOLLY;break;case de.ROTATE:if(u.ctrlKey||u.metaKey||u.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(u),this.state=D.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(u),this.state=D.ROTATE}break;case de.PAN:if(u.ctrlKey||u.metaKey||u.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(u),this.state=D.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(u),this.state=D.PAN}break;default:this.state=D.NONE}this.state!==D.NONE&&this.dispatchEvent(ft)}function Us(u){switch(this.state){case D.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(u);break;case D.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(u);break;case D.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(u);break}}function $s(u){this.enabled===!1||this.enableZoom===!1||this.state!==D.NONE||(u.preventDefault(),this.dispatchEvent(ft),this._handleMouseWheel(this._customWheelEvent(u)),this.dispatchEvent(Xt))}function Vs(u){this.enabled===!1||this.enablePan===!1||this._handleKeyDown(u)}function Xs(u){switch(this._trackPointer(u),this._pointers.length){case 1:switch(this.touches.ONE){case fe.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(u),this.state=D.TOUCH_ROTATE;break;case fe.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(u),this.state=D.TOUCH_PAN;break;default:this.state=D.NONE}break;case 2:switch(this.touches.TWO){case fe.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(u),this.state=D.TOUCH_DOLLY_PAN;break;case fe.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(u),this.state=D.TOUCH_DOLLY_ROTATE;break;default:this.state=D.NONE}break;default:this.state=D.NONE}this.state!==D.NONE&&this.dispatchEvent(ft)}function Ys(u){switch(this._trackPointer(u),this.state){case D.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(u),this.update();break;case D.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(u),this.update();break;case D.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(u),this.update();break;case D.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(u),this.update();break;default:this.state=D.NONE}}function Ks(u){this.enabled!==!1&&u.preventDefault()}function Zs(u){u.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function Ws(u){u.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}const ge=new Ht,Y=new S,ue=new S,z=new H,Pt={X:new S(1,0,0),Y:new S(0,1,0),Z:new S(0,0,1)},ot={type:"change"},Rt={type:"mouseDown",mode:null},Lt={type:"mouseUp",mode:null},Ct={type:"objectChange"};class qs extends zt{constructor(e,t=null){super(void 0,t);const n=new nn(this);this._root=n;const s=new on;this._gizmo=s,n.add(s);const i=new rn;this._plane=i,n.add(i);const o=this;function r(_,b){let x=b;Object.defineProperty(o,_,{get:function(){return x!==void 0?x:b},set:function(M){x!==M&&(x=M,i[_]=M,s[_]=M,o.dispatchEvent({type:_+"-changed",value:M}),o.dispatchEvent(ot))}}),o[_]=b,i[_]=b,s[_]=b}r("camera",e),r("object",void 0),r("enabled",!0),r("axis",null),r("mode","translate"),r("translationSnap",null),r("rotationSnap",null),r("scaleSnap",null),r("space","world"),r("size",1),r("dragging",!1),r("showX",!0),r("showY",!0),r("showZ",!0),r("minX",-1/0),r("maxX",1/0),r("minY",-1/0),r("maxY",1/0),r("minZ",-1/0),r("maxZ",1/0);const a=new S,c=new S,l=new H,h=new H,d=new S,g=new H,y=new S,m=new S,p=new S,f=0,w=new S;r("worldPosition",a),r("worldPositionStart",c),r("worldQuaternion",l),r("worldQuaternionStart",h),r("cameraPosition",d),r("cameraQuaternion",g),r("pointStart",y),r("pointEnd",m),r("rotationAxis",p),r("rotationAngle",f),r("eye",w),this._offset=new S,this._startNorm=new S,this._endNorm=new S,this._cameraScale=new S,this._parentPosition=new S,this._parentQuaternion=new H,this._parentQuaternionInv=new H,this._parentScale=new S,this._worldScaleStart=new S,this._worldQuaternionInv=new H,this._worldScale=new S,this._positionStart=new S,this._quaternionStart=new H,this._scaleStart=new S,this._getPointer=Qs.bind(this),this._onPointerDown=en.bind(this),this._onPointerHover=Js.bind(this),this._onPointerMove=tn.bind(this),this._onPointerUp=sn.bind(this),t!==null&&this.connect()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(e){if(this.object===void 0||this.dragging===!0)return;e!==null&&ge.setFromCamera(e,this.camera);const t=it(this._gizmo.picker[this.mode],ge);t?this.axis=t.object.name:this.axis=null}pointerDown(e){if(!(this.object===void 0||this.dragging===!0||e!=null&&e.button!==0)&&this.axis!==null){e!==null&&ge.setFromCamera(e,this.camera);const t=it(this._plane,ge,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,Rt.mode=this.mode,this.dispatchEvent(Rt)}}pointerMove(e){const t=this.axis,n=this.mode,s=this.object;let i=this.space;if(n==="scale"?i="local":(t==="E"||t==="XYZE"||t==="XYZ")&&(i="world"),s===void 0||t===null||this.dragging===!1||e!==null&&e.button!==-1)return;e!==null&&ge.setFromCamera(e,this.camera);const o=it(this._plane,ge,!0);if(o){if(this.pointEnd.copy(o.point).sub(this.worldPositionStart),n==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),i==="local"&&t!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),t.indexOf("X")===-1&&(this._offset.x=0),t.indexOf("Y")===-1&&(this._offset.y=0),t.indexOf("Z")===-1&&(this._offset.z=0),i==="local"&&t!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),s.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(i==="local"&&(s.position.applyQuaternion(z.copy(this._quaternionStart).invert()),t.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(this._quaternionStart)),i==="world"&&(s.parent&&s.position.add(Y.setFromMatrixPosition(s.parent.matrixWorld)),t.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(Y.setFromMatrixPosition(s.parent.matrixWorld)))),s.position.x=Math.max(this.minX,Math.min(this.maxX,s.position.x)),s.position.y=Math.max(this.minY,Math.min(this.maxY,s.position.y)),s.position.z=Math.max(this.minZ,Math.min(this.maxZ,s.position.z));else if(n==="scale"){if(t.search("XYZ")!==-1){let r=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(r*=-1),ue.set(r,r,r)}else Y.copy(this.pointStart),ue.copy(this.pointEnd),Y.applyQuaternion(this._worldQuaternionInv),ue.applyQuaternion(this._worldQuaternionInv),ue.divide(Y),t.search("X")===-1&&(ue.x=1),t.search("Y")===-1&&(ue.y=1),t.search("Z")===-1&&(ue.z=1);s.scale.copy(this._scaleStart).multiply(ue),this.scaleSnap&&(t.search("X")!==-1&&(s.scale.x=Math.round(s.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Y")!==-1&&(s.scale.y=Math.round(s.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Z")!==-1&&(s.scale.z=Math.round(s.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(n==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const r=20/this.worldPosition.distanceTo(Y.setFromMatrixPosition(this.camera.matrixWorld));let a=!1;t==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(Y.copy(this.rotationAxis).cross(this.eye))*r):(t==="X"||t==="Y"||t==="Z")&&(this.rotationAxis.copy(Pt[t]),Y.copy(Pt[t]),i==="local"&&Y.applyQuaternion(this.worldQuaternion),Y.cross(this.eye),Y.length()===0?a=!0:this.rotationAngle=this._offset.dot(Y.normalize())*r),(t==="E"||a)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),i==="local"&&t!=="E"&&t!=="XYZE"?(s.quaternion.copy(this._quaternionStart),s.quaternion.multiply(z.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),s.quaternion.copy(z.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),s.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(ot),this.dispatchEvent(Ct)}}pointerUp(e){e!==null&&e.button!==0||(this.dragging&&this.axis!==null&&(Lt.mode=this.mode,this.dispatchEvent(Lt)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(e){return this.object=e,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(ot),this.dispatchEvent(Ct),this.pointStart.copy(this.pointEnd))}getRaycaster(){return ge}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}}function Qs(u){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:u.button};{const e=this.domElement.getBoundingClientRect();return{x:(u.clientX-e.left)/e.width*2-1,y:-(u.clientY-e.top)/e.height*2+1,button:u.button}}}function Js(u){if(this.enabled)switch(u.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(u));break}}function en(u){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(u.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(u)),this.pointerDown(this._getPointer(u)))}function tn(u){this.enabled&&this.pointerMove(this._getPointer(u))}function sn(u){this.enabled&&(this.domElement.releasePointerCapture(u.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(u)))}function it(u,e,t){const n=e.intersectObject(u,!0);for(let s=0;s<n.length;s++)if(n[s].object.visible||t)return n[s];return!1}const Ve=new Jt,N=new S(0,1,0),vt=new S(0,0,0),It=new Ee,Xe=new H,Ze=new H,oe=new S,kt=new Ee,Ie=new S(1,0,0),we=new S(0,1,0),ke=new S(0,0,1),Ye=new S,Re=new S,Le=new S;class nn extends Ge{constructor(e){super(),this.isTransformControlsRoot=!0,this.controls=e,this.visible=!1}updateMatrixWorld(e){const t=this.controls;t.object!==void 0&&(t.object.updateMatrixWorld(),t.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):t.object.parent.matrixWorld.decompose(t._parentPosition,t._parentQuaternion,t._parentScale),t.object.matrixWorld.decompose(t.worldPosition,t.worldQuaternion,t._worldScale),t._parentQuaternionInv.copy(t._parentQuaternion).invert(),t._worldQuaternionInv.copy(t.worldQuaternion).invert()),t.camera.updateMatrixWorld(),t.camera.matrixWorld.decompose(t.cameraPosition,t.cameraQuaternion,t._cameraScale),t.camera.isOrthographicCamera?t.camera.getWorldDirection(t.eye).negate():t.eye.copy(t.cameraPosition).sub(t.worldPosition).normalize(),super.updateMatrixWorld(e)}dispose(){this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}}class on extends Ge{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new re({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new We({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),n=e.clone();n.opacity=.15;const s=t.clone();s.opacity=.5;const i=e.clone();i.color.setHex(16711680);const o=e.clone();o.color.setHex(65280);const r=e.clone();r.color.setHex(255);const a=e.clone();a.color.setHex(16711680),a.opacity=.5;const c=e.clone();c.color.setHex(65280),c.opacity=.5;const l=e.clone();l.color.setHex(255),l.opacity=.5;const h=e.clone();h.opacity=.25;const d=e.clone();d.color.setHex(16776960),d.opacity=.25,e.clone().color.setHex(16776960);const y=e.clone();y.color.setHex(7895160);const m=new $(0,.04,.1,12);m.translate(0,.05,0);const p=new V(.08,.08,.08);p.translate(0,.04,0);const f=new ze;f.setAttribute("position",new yt([0,0,0,1,0,0],3));const w=new $(.0075,.0075,.5,3);w.translate(0,.25,0);function _(I,O){const U=new Me(I,.0075,3,64,O*Math.PI*2);return U.rotateY(Math.PI/2),U.rotateX(Math.PI/2),U}function b(){const I=new ze;return I.setAttribute("position",new yt([0,0,0,1,1,1],3)),I}const x={X:[[new E(m,i),[.5,0,0],[0,0,-Math.PI/2]],[new E(m,i),[-.5,0,0],[0,0,Math.PI/2]],[new E(w,i),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new E(m,o),[0,.5,0]],[new E(m,o),[0,-.5,0],[Math.PI,0,0]],[new E(w,o)]],Z:[[new E(m,r),[0,0,.5],[Math.PI/2,0,0]],[new E(m,r),[0,0,-.5],[-Math.PI/2,0,0]],[new E(w,r),null,[Math.PI/2,0,0]]],XYZ:[[new E(new je(.1,0),h.clone()),[0,0,0]]],XY:[[new E(new V(.15,.15,.01),l.clone()),[.15,.15,0]]],YZ:[[new E(new V(.15,.15,.01),a.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new E(new V(.15,.15,.01),c.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},M={X:[[new E(new $(.2,0,.6,4),n),[.3,0,0],[0,0,-Math.PI/2]],[new E(new $(.2,0,.6,4),n),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new E(new $(.2,0,.6,4),n),[0,.3,0]],[new E(new $(.2,0,.6,4),n),[0,-.3,0],[0,0,Math.PI]]],Z:[[new E(new $(.2,0,.6,4),n),[0,0,.3],[Math.PI/2,0,0]],[new E(new $(.2,0,.6,4),n),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new E(new je(.2,0),n)]],XY:[[new E(new V(.2,.2,.01),n),[.15,.15,0]]],YZ:[[new E(new V(.2,.2,.01),n),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new E(new V(.2,.2,.01),n),[.15,0,.15],[-Math.PI/2,0,0]]]},v={START:[[new E(new je(.01,2),s),null,null,null,"helper"]],END:[[new E(new je(.01,2),s),null,null,null,"helper"]],DELTA:[[new ie(b(),s),null,null,null,"helper"]],X:[[new ie(f,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new ie(f,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new ie(f,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},T={XYZE:[[new E(_(.5,1),y),null,[0,Math.PI/2,0]]],X:[[new E(_(.5,.5),i)]],Y:[[new E(_(.5,.5),o),null,[0,0,-Math.PI/2]]],Z:[[new E(_(.5,.5),r),null,[0,Math.PI/2,0]]],E:[[new E(_(.75,1),d),null,[0,Math.PI/2,0]]]},A={AXIS:[[new ie(f,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},P={XYZE:[[new E(new Qt(.25,10,8),n)]],X:[[new E(new Me(.5,.1,4,24),n),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new E(new Me(.5,.1,4,24),n),[0,0,0],[Math.PI/2,0,0]]],Z:[[new E(new Me(.5,.1,4,24),n),[0,0,0],[0,0,-Math.PI/2]]],E:[[new E(new Me(.75,.1,2,24),n)]]},k={X:[[new E(p,i),[.5,0,0],[0,0,-Math.PI/2]],[new E(w,i),[0,0,0],[0,0,-Math.PI/2]],[new E(p,i),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new E(p,o),[0,.5,0]],[new E(w,o)],[new E(p,o),[0,-.5,0],[0,0,Math.PI]]],Z:[[new E(p,r),[0,0,.5],[Math.PI/2,0,0]],[new E(w,r),[0,0,0],[Math.PI/2,0,0]],[new E(p,r),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new E(new V(.15,.15,.01),l),[.15,.15,0]]],YZ:[[new E(new V(.15,.15,.01),a),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new E(new V(.15,.15,.01),c),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new E(new V(.1,.1,.1),h.clone())]]},G={X:[[new E(new $(.2,0,.6,4),n),[.3,0,0],[0,0,-Math.PI/2]],[new E(new $(.2,0,.6,4),n),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new E(new $(.2,0,.6,4),n),[0,.3,0]],[new E(new $(.2,0,.6,4),n),[0,-.3,0],[0,0,Math.PI]]],Z:[[new E(new $(.2,0,.6,4),n),[0,0,.3],[Math.PI/2,0,0]],[new E(new $(.2,0,.6,4),n),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new E(new V(.2,.2,.01),n),[.15,.15,0]]],YZ:[[new E(new V(.2,.2,.01),n),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new E(new V(.2,.2,.01),n),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new E(new V(.2,.2,.2),n),[0,0,0]]]},F={X:[[new ie(f,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new ie(f,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new ie(f,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function R(I){const O=new Ge;for(const U in I)for(let ce=I[U].length;ce--;){const j=I[U][ce][0].clone(),W=I[U][ce][1],be=I[U][ce][2],q=I[U][ce][3],se=I[U][ce][4];j.name=U,j.tag=se,W&&j.position.set(W[0],W[1],W[2]),be&&j.rotation.set(be[0],be[1],be[2]),q&&j.scale.set(q[0],q[1],q[2]),j.updateMatrix();const Te=j.geometry.clone();Te.applyMatrix4(j.matrix),j.geometry=Te,j.renderOrder=1/0,j.position.set(0,0,0),j.rotation.set(0,0,0),j.scale.set(1,1,1),O.add(j)}return O}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=R(x)),this.add(this.gizmo.rotate=R(T)),this.add(this.gizmo.scale=R(k)),this.add(this.picker.translate=R(M)),this.add(this.picker.rotate=R(P)),this.add(this.picker.scale=R(G)),this.add(this.helper.translate=R(v)),this.add(this.helper.rotate=R(A)),this.add(this.helper.scale=R(F)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const n=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:Ze;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let i=0;i<s.length;i++){const o=s[i];o.visible=!0,o.rotation.set(0,0,0),o.position.copy(this.worldPosition);let r;if(this.camera.isOrthographicCamera?r=(this.camera.top-this.camera.bottom)/this.camera.zoom:r=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),o.scale.set(1,1,1).multiplyScalar(r*this.size/4),o.tag==="helper"){o.visible=!1,o.name==="AXIS"?(o.visible=!!this.axis,this.axis==="X"&&(z.setFromEuler(Ve.set(0,0,0)),o.quaternion.copy(n).multiply(z),Math.abs(N.copy(Ie).applyQuaternion(n).dot(this.eye))>.9&&(o.visible=!1)),this.axis==="Y"&&(z.setFromEuler(Ve.set(0,0,Math.PI/2)),o.quaternion.copy(n).multiply(z),Math.abs(N.copy(we).applyQuaternion(n).dot(this.eye))>.9&&(o.visible=!1)),this.axis==="Z"&&(z.setFromEuler(Ve.set(0,Math.PI/2,0)),o.quaternion.copy(n).multiply(z),Math.abs(N.copy(ke).applyQuaternion(n).dot(this.eye))>.9&&(o.visible=!1)),this.axis==="XYZE"&&(z.setFromEuler(Ve.set(0,Math.PI/2,0)),N.copy(this.rotationAxis),o.quaternion.setFromRotationMatrix(It.lookAt(vt,N,we)),o.quaternion.multiply(z),o.visible=this.dragging),this.axis==="E"&&(o.visible=!1)):o.name==="START"?(o.position.copy(this.worldPositionStart),o.visible=this.dragging):o.name==="END"?(o.position.copy(this.worldPosition),o.visible=this.dragging):o.name==="DELTA"?(o.position.copy(this.worldPositionStart),o.quaternion.copy(this.worldQuaternionStart),Y.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),Y.applyQuaternion(this.worldQuaternionStart.clone().invert()),o.scale.copy(Y),o.visible=this.dragging):(o.quaternion.copy(n),this.dragging?o.position.copy(this.worldPositionStart):o.position.copy(this.worldPosition),this.axis&&(o.visible=this.axis.search(o.name)!==-1));continue}o.quaternion.copy(n),this.mode==="translate"||this.mode==="scale"?(o.name==="X"&&Math.abs(N.copy(Ie).applyQuaternion(n).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="Y"&&Math.abs(N.copy(we).applyQuaternion(n).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="Z"&&Math.abs(N.copy(ke).applyQuaternion(n).dot(this.eye))>.99&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="XY"&&Math.abs(N.copy(ke).applyQuaternion(n).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="YZ"&&Math.abs(N.copy(Ie).applyQuaternion(n).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),o.name==="XZ"&&Math.abs(N.copy(we).applyQuaternion(n).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1)):this.mode==="rotate"&&(Xe.copy(n),N.copy(this.eye).applyQuaternion(z.copy(n).invert()),o.name.search("E")!==-1&&o.quaternion.setFromRotationMatrix(It.lookAt(this.eye,vt,we)),o.name==="X"&&(z.setFromAxisAngle(Ie,Math.atan2(-N.y,N.z)),z.multiplyQuaternions(Xe,z),o.quaternion.copy(z)),o.name==="Y"&&(z.setFromAxisAngle(we,Math.atan2(N.x,N.z)),z.multiplyQuaternions(Xe,z),o.quaternion.copy(z)),o.name==="Z"&&(z.setFromAxisAngle(ke,Math.atan2(N.y,N.x)),z.multiplyQuaternions(Xe,z),o.quaternion.copy(z))),o.visible=o.visible&&(o.name.indexOf("X")===-1||this.showX),o.visible=o.visible&&(o.name.indexOf("Y")===-1||this.showY),o.visible=o.visible&&(o.name.indexOf("Z")===-1||this.showZ),o.visible=o.visible&&(o.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),o.material._color=o.material._color||o.material.color.clone(),o.material._opacity=o.material._opacity||o.material.opacity,o.material.color.copy(o.material._color),o.material.opacity=o.material._opacity,this.enabled&&this.axis&&(o.name===this.axis||this.axis.split("").some(function(a){return o.name===a}))&&(o.material.color.setHex(16776960),o.material.opacity=1)}super.updateMatrixWorld(e)}}class rn extends E{constructor(){super(new Ke(1e5,1e5,2,2),new re({visible:!1,wireframe:!0,side:X,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let t=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(t="local"),Ye.copy(Ie).applyQuaternion(t==="local"?this.worldQuaternion:Ze),Re.copy(we).applyQuaternion(t==="local"?this.worldQuaternion:Ze),Le.copy(ke).applyQuaternion(t==="local"?this.worldQuaternion:Ze),N.copy(Re),this.mode){case"translate":case"scale":switch(this.axis){case"X":N.copy(this.eye).cross(Ye),oe.copy(Ye).cross(N);break;case"Y":N.copy(this.eye).cross(Re),oe.copy(Re).cross(N);break;case"Z":N.copy(this.eye).cross(Le),oe.copy(Le).cross(N);break;case"XY":oe.copy(Le);break;case"YZ":oe.copy(Ye);break;case"XZ":N.copy(Le),oe.copy(Re);break;case"XYZ":case"E":oe.set(0,0,0);break}break;case"rotate":default:oe.set(0,0,0)}oe.length()===0?this.quaternion.copy(this.cameraQuaternion):(kt.lookAt(Y.set(0,0,0),oe,N),this.quaternion.setFromRotationMatrix(kt)),super.updateMatrixWorld(e)}}function Ot(u,e){if(e===es)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),u;if(e===ht||e===jt){let t=u.getIndex();if(t===null){const o=[],r=u.getAttribute("position");if(r!==void 0){for(let a=0;a<r.count;a++)o.push(a);u.setIndex(o),t=u.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),u}const n=t.count-2,s=[];if(e===ht)for(let o=1;o<=n;o++)s.push(t.getX(0)),s.push(t.getX(o)),s.push(t.getX(o+1));else for(let o=0;o<n;o++)o%2===0?(s.push(t.getX(o)),s.push(t.getX(o+1)),s.push(t.getX(o+2))):(s.push(t.getX(o+2)),s.push(t.getX(o+1)),s.push(t.getX(o)));s.length/3!==n&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=u.clone();return i.setIndex(s),i.clearGroups(),i}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),u}class an extends Bt{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new un(t)}),this.register(function(t){return new pn(t)}),this.register(function(t){return new Sn(t)}),this.register(function(t){return new En(t)}),this.register(function(t){return new Tn(t)}),this.register(function(t){return new fn(t)}),this.register(function(t){return new gn(t)}),this.register(function(t){return new yn(t)}),this.register(function(t){return new wn(t)}),this.register(function(t){return new dn(t)}),this.register(function(t){return new bn(t)}),this.register(function(t){return new mn(t)}),this.register(function(t){return new xn(t)}),this.register(function(t){return new _n(t)}),this.register(function(t){return new ln(t)}),this.register(function(t){return new Mn(t)}),this.register(function(t){return new An(t)})}load(e,t,n,s){const i=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const c=De.extractUrlBase(e);o=De.resolveURL(c,this.path)}else o=De.extractUrlBase(e);this.manager.itemStart(e);const r=function(c){s?s(c):console.error(c),i.manager.itemError(e),i.manager.itemEnd(e)},a=new qe(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(c){try{i.parse(c,o,function(l){t(l),i.manager.itemEnd(e)},r)}catch(l){r(l)}},n,r)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,s){let i;const o={},r={},a=new TextDecoder;if(typeof e=="string")i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Yt){try{o[C.KHR_BINARY_GLTF]=new Pn(e)}catch(h){s&&s(h);return}i=JSON.parse(o[C.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(i.asset===void 0||i.asset.version[0]<2){s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new Hn(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let l=0;l<this.pluginCallbacks.length;l++){const h=this.pluginCallbacks[l](c);h.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),r[h.name]=h,o[h.name]=!0}if(i.extensionsUsed)for(let l=0;l<i.extensionsUsed.length;++l){const h=i.extensionsUsed[l],d=i.extensionsRequired||[];switch(h){case C.KHR_MATERIALS_UNLIT:o[h]=new hn;break;case C.KHR_DRACO_MESH_COMPRESSION:o[h]=new Rn(i,this.dracoLoader);break;case C.KHR_TEXTURE_TRANSFORM:o[h]=new Ln;break;case C.KHR_MESH_QUANTIZATION:o[h]=new Cn;break;default:d.indexOf(h)>=0&&r[h]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}c.setExtensions(o),c.setPlugins(r),c.parse(n,s)}parseAsync(e,t){const n=this;return new Promise(function(s,i){n.parse(e,t,s,i)})}}function cn(){let u={};return{get:function(e){return u[e]},add:function(e,t){u[e]=t},remove:function(e){delete u[e]},removeAll:function(){u={}}}}const C={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ln{constructor(e){this.parser=e,this.name=C.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,s=t.length;n<s;n++){const i=t[n];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let s=t.cache.get(n);if(s)return s;const i=t.json,a=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let c;const l=new te(16777215);a.color!==void 0&&l.setRGB(a.color[0],a.color[1],a.color[2],ne);const h=a.range!==void 0?a.range:0;switch(a.type){case"directional":c=new dt(l),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new ss(l),c.distance=h;break;case"spot":c=new ts(l),c.distance=h,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,c.angle=a.spot.outerConeAngle,c.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return c.position.set(0,0,0),c.decay=2,le(c,a),a.intensity!==void 0&&(c.intensity=a.intensity),c.name=t.createUniqueName(a.name||"light_"+e),s=Promise.resolve(c),t.cache.add(n,s),s}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,i=n.json.nodes[e],r=(i.extensions&&i.extensions[this.name]||{}).light;return r===void 0?null:this._loadLight(r).then(function(a){return n._getNodeRef(t.cache,r,a)})}}class hn{constructor(){this.name=C.KHR_MATERIALS_UNLIT}getMaterialType(){return re}extendParams(e,t,n){const s=[];e.color=new te(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const o=i.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],ne),e.opacity=o[3]}i.baseColorTexture!==void 0&&s.push(n.assignTexture(e,"map",i.baseColorTexture,Z))}return Promise.all(s)}}class dn{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name].emissiveStrength;return i!==void 0&&(t.emissiveIntensity=i),Promise.resolve()}}class un{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:ae}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&i.push(n.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&i.push(n.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(i.push(n.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const r=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new K(r,r)}return Promise.all(i)}}class pn{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_DISPERSION}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:ae}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.dispersion=i.dispersion!==void 0?i.dispersion:0,Promise.resolve()}}class mn{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:ae}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&i.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&i.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class fn{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_SHEEN}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:ae}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new te(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=s.extensions[this.name];if(o.sheenColorFactor!==void 0){const r=o.sheenColorFactor;t.sheenColor.setRGB(r[0],r[1],r[2],ne)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&i.push(n.assignTexture(t,"sheenColorMap",o.sheenColorTexture,Z)),o.sheenRoughnessTexture!==void 0&&i.push(n.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(i)}}class gn{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:ae}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&i.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class yn{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_VOLUME}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:ae}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&i.push(n.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const r=o.attenuationColor||[1,1,1];return t.attenuationColor=new te().setRGB(r[0],r[1],r[2],ne),Promise.all(i)}}class wn{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_IOR}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:ae}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.ior=i.ior!==void 0?i.ior:1.5,Promise.resolve()}}class bn{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_SPECULAR}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:ae}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&i.push(n.assignTexture(t,"specularIntensityMap",o.specularTexture));const r=o.specularColorFactor||[1,1,1];return t.specularColor=new te().setRGB(r[0],r[1],r[2],ne),o.specularColorTexture!==void 0&&i.push(n.assignTexture(t,"specularColorMap",o.specularColorTexture,Z)),Promise.all(i)}}class _n{constructor(e){this.parser=e,this.name=C.EXT_MATERIALS_BUMP}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:ae}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&i.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class xn{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:ae}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&i.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class Sn{constructor(e){this.parser=e,this.name=C.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,s=n.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const i=s.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,o)}}class En{constructor(e){this.parser=e,this.name=C.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,s=n.json,i=s.textures[e];if(!i.extensions||!i.extensions[t])return null;const o=i.extensions[t],r=s.images[o.source];let a=n.textureLoader;if(r.uri){const c=n.options.manager.getHandler(r.uri);c!==null&&(a=c)}return this.detectSupport().then(function(c){if(c)return n.loadTextureImage(e,o.source,a);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Tn{constructor(e){this.parser=e,this.name=C.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,s=n.json,i=s.textures[e];if(!i.extensions||!i.extensions[t])return null;const o=i.extensions[t],r=s.images[o.source];let a=n.textureLoader;if(r.uri){const c=n.options.manager.getHandler(r.uri);c!==null&&(a=c)}return this.detectSupport().then(function(c){if(c)return n.loadTextureImage(e,o.source,a);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return n.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Mn{constructor(e){this.name=C.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const s=n.extensions[this.name],i=this.parser.getDependency("buffer",s.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(r){const a=s.byteOffset||0,c=s.byteLength||0,l=s.count,h=s.byteStride,d=new Uint8Array(r,a,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(l,h,d,s.mode,s.filter).then(function(g){return g.buffer}):o.ready.then(function(){const g=new ArrayBuffer(l*h);return o.decodeGltfBuffer(new Uint8Array(g),l,h,d,s.mode,s.filter),g})})}else return null}}class An{constructor(e){this.name=C.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||n.mesh===void 0)return null;const s=t.meshes[n.mesh];for(const c of s.primitives)if(c.mode!==ee.TRIANGLES&&c.mode!==ee.TRIANGLE_STRIP&&c.mode!==ee.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=n.extensions[this.name].attributes,r=[],a={};for(const c in o)r.push(this.parser.getDependency("accessor",o[c]).then(l=>(a[c]=l,a[c])));return r.length<1?null:(r.push(this.parser.createNodeMesh(e)),Promise.all(r).then(c=>{const l=c.pop(),h=l.isGroup?l.children:[l],d=c[0].count,g=[];for(const y of h){const m=new Ee,p=new S,f=new H,w=new S(1,1,1),_=new ns(y.geometry,y.material,d);for(let b=0;b<d;b++)a.TRANSLATION&&p.fromBufferAttribute(a.TRANSLATION,b),a.ROTATION&&f.fromBufferAttribute(a.ROTATION,b),a.SCALE&&w.fromBufferAttribute(a.SCALE,b),_.setMatrixAt(b,m.compose(p,f,w));for(const b in a)if(b==="_COLOR_0"){const x=a[b];_.instanceColor=new os(x.array,x.itemSize,x.normalized)}else b!=="TRANSLATION"&&b!=="ROTATION"&&b!=="SCALE"&&y.geometry.setAttribute(b,a[b]);Ge.prototype.copy.call(_,y),this.parser.assignFinalMaterial(_),g.push(_)}return l.isGroup?(l.clear(),l.add(...g),l):g[0]}))}}const Yt="glTF",Ce=12,Dt={JSON:1313821514,BIN:5130562};class Pn{constructor(e){this.name=C.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Ce),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Yt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-Ce,i=new DataView(e,Ce);let o=0;for(;o<s;){const r=i.getUint32(o,!0);o+=4;const a=i.getUint32(o,!0);if(o+=4,a===Dt.JSON){const c=new Uint8Array(e,Ce+o,r);this.content=n.decode(c)}else if(a===Dt.BIN){const c=Ce+o;this.body=e.slice(c,c+r)}o+=r}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Rn{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=C.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,s=this.dracoLoader,i=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,r={},a={},c={};for(const l in o){const h=pt[l]||l.toLowerCase();r[h]=o[l]}for(const l in e.attributes){const h=pt[l]||l.toLowerCase();if(o[l]!==void 0){const d=n.accessors[e.attributes[l]],g=Se[d.componentType];c[h]=g.name,a[h]=d.normalized===!0}}return t.getDependency("bufferView",i).then(function(l){return new Promise(function(h,d){s.decodeDracoFile(l,function(g){for(const y in g.attributes){const m=g.attributes[y],p=a[y];p!==void 0&&(m.normalized=p)}h(g)},r,c,ne,d)})})}}class Ln{constructor(){this.name=C.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Cn{constructor(){this.name=C.KHR_MESH_QUANTIZATION}}class Kt extends Ts{constructor(e,t,n,s){super(e,t,n,s)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,s=this.valueSize,i=e*s*3+s;for(let o=0;o!==s;o++)t[o]=n[i+o];return t}interpolate_(e,t,n,s){const i=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=r*2,c=r*3,l=s-t,h=(n-t)/l,d=h*h,g=d*h,y=e*c,m=y-c,p=-2*g+3*d,f=g-d,w=1-p,_=f-d+h;for(let b=0;b!==r;b++){const x=o[m+b+r],M=o[m+b+a]*l,v=o[y+b+r],T=o[y+b]*l;i[b]=w*x+_*M+p*v+f*T}return i}}const vn=new H;class In extends Kt{interpolate_(e,t,n,s){const i=super.interpolate_(e,t,n,s);return vn.fromArray(i).normalize().toArray(i),i}}const ee={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},Se={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Nt={9728:me,9729:He,9984:ls,9985:cs,9986:as,9987:Qe},Ft={33071:ds,33648:hs,10497:he},rt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},pt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},pe={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},kn={CUBICSPLINE:void 0,LINEAR:Vt,STEP:xs},at={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function On(u){return u.DefaultMaterial===void 0&&(u.DefaultMaterial=new xe({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Es})),u.DefaultMaterial}function ye(u,e,t){for(const n in t.extensions)u[n]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=t.extensions[n])}function le(u,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(u.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Dn(u,e,t){let n=!1,s=!1,i=!1;for(let c=0,l=e.length;c<l;c++){const h=e[c];if(h.POSITION!==void 0&&(n=!0),h.NORMAL!==void 0&&(s=!0),h.COLOR_0!==void 0&&(i=!0),n&&s&&i)break}if(!n&&!s&&!i)return Promise.resolve(u);const o=[],r=[],a=[];for(let c=0,l=e.length;c<l;c++){const h=e[c];if(n){const d=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):u.attributes.position;o.push(d)}if(s){const d=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):u.attributes.normal;r.push(d)}if(i){const d=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):u.attributes.color;a.push(d)}}return Promise.all([Promise.all(o),Promise.all(r),Promise.all(a)]).then(function(c){const l=c[0],h=c[1],d=c[2];return n&&(u.morphAttributes.position=l),s&&(u.morphAttributes.normal=h),i&&(u.morphAttributes.color=d),u.morphTargetsRelative=!0,u})}function Nn(u,e){if(u.updateMorphTargets(),e.weights!==void 0)for(let t=0,n=e.weights.length;t<n;t++)u.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(u.morphTargetInfluences.length===t.length){u.morphTargetDictionary={};for(let n=0,s=t.length;n<s;n++)u.morphTargetDictionary[t[n]]=n}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Fn(u){let e;const t=u.extensions&&u.extensions[C.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+ct(t.attributes):e=u.indices+":"+ct(u.attributes)+":"+u.mode,u.targets!==void 0)for(let n=0,s=u.targets.length;n<s;n++)e+=":"+ct(u.targets[n]);return e}function ct(u){let e="";const t=Object.keys(u).sort();for(let n=0,s=t.length;n<s;n++)e+=t[n]+":"+u[t[n]]+";";return e}function mt(u){switch(u){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Gn(u){return u.search(/\.jpe?g($|\?)/i)>0||u.search(/^data\:image\/jpeg/)===0?"image/jpeg":u.search(/\.webp($|\?)/i)>0||u.search(/^data\:image\/webp/)===0?"image/webp":u.search(/\.ktx2($|\?)/i)>0||u.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const zn=new Ee;class Hn{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new cn,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,s=-1,i=!1,o=-1;if(typeof navigator<"u"){const r=navigator.userAgent;n=/^((?!chrome|android).)*safari/i.test(r)===!0;const a=r.match(/Version\/(\d+)/);s=n&&a?parseInt(a[1],10):-1,i=r.indexOf("Firefox")>-1,o=i?r.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||n&&s<17||i&&o<98?this.textureLoader=new _e(this.options.manager):this.textureLoader=new is(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new qe(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,s=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(o){const r={scene:o[0][s.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:s.asset,parser:n,userData:{}};return ye(i,r,s),le(r,s),Promise.all(n._invokeAll(function(a){return a.afterRoot&&a.afterRoot(r)})).then(function(){for(const a of r.scenes)a.updateMatrixWorld();e(r)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let s=0,i=t.length;s<i;s++){const o=t[s].joints;for(let r=0,a=o.length;r<a;r++)e[o[r]].isBone=!0}for(let s=0,i=e.length;s<i;s++){const o=e[s];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(n[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const s=n.clone(),i=(o,r)=>{const a=this.associations.get(o);a!=null&&this.associations.set(r,a);for(const[c,l]of o.children.entries())i(l,r.children[c])};return i(n,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const s=e(t[n]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let s=0;s<t.length;s++){const i=e(t[s]);i&&n.push(i)}return n}getDependency(e,t){const n=e+":"+t;let s=this.cache.get(n);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne(function(i){return i.loadNode&&i.loadNode(t)});break;case"mesh":s=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne(function(i){return i.loadAnimation&&i.loadAnimation(t)});break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne(function(i){return i!=this&&i.getDependency&&i.getDependency(e,t)}),!s)throw new Error("Unknown type: "+e);break}this.cache.add(n,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,s=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(s.map(function(i,o){return n.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[C.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(i,o){n.load(De.resolveURL(t.uri,s.path),i,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(n){const s=t.byteLength||0,i=t.byteOffset||0;return n.slice(i,i+s)})}loadAccessor(e){const t=this,n=this.json,s=this.json.accessors[e];if(s.bufferView===void 0&&s.sparse===void 0){const o=rt[s.type],r=Se[s.componentType],a=s.normalized===!0,c=new r(s.count*o);return Promise.resolve(new Ne(c,o,a))}const i=[];return s.bufferView!==void 0?i.push(this.getDependency("bufferView",s.bufferView)):i.push(null),s.sparse!==void 0&&(i.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(i).then(function(o){const r=o[0],a=rt[s.type],c=Se[s.componentType],l=c.BYTES_PER_ELEMENT,h=l*a,d=s.byteOffset||0,g=s.bufferView!==void 0?n.bufferViews[s.bufferView].byteStride:void 0,y=s.normalized===!0;let m,p;if(g&&g!==h){const f=Math.floor(d/g),w="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+f+":"+s.count;let _=t.cache.get(w);_||(m=new c(r,f*g,s.count*g/l),_=new rs(m,g/l),t.cache.add(w,_)),p=new Ss(_,a,d%g/l,y)}else r===null?m=new c(s.count*a):m=new c(r,d,s.count*a),p=new Ne(m,a,y);if(s.sparse!==void 0){const f=rt.SCALAR,w=Se[s.sparse.indices.componentType],_=s.sparse.indices.byteOffset||0,b=s.sparse.values.byteOffset||0,x=new w(o[1],_,s.sparse.count*f),M=new c(o[2],b,s.sparse.count*a);r!==null&&(p=new Ne(p.array.slice(),p.itemSize,p.normalized)),p.normalized=!1;for(let v=0,T=x.length;v<T;v++){const A=x[v];if(p.setX(A,M[v*a]),a>=2&&p.setY(A,M[v*a+1]),a>=3&&p.setZ(A,M[v*a+2]),a>=4&&p.setW(A,M[v*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}p.normalized=y}return p})}loadTexture(e){const t=this.json,n=this.options,i=t.textures[e].source,o=t.images[i];let r=this.textureLoader;if(o.uri){const a=n.manager.getHandler(o.uri);a!==null&&(r=a)}return this.loadTextureImage(e,i,r)}loadTextureImage(e,t,n){const s=this,i=this.json,o=i.textures[e],r=i.images[t],a=(r.uri||r.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const c=this.loadImageSource(t,n).then(function(l){l.flipY=!1,l.name=o.name||r.name||"",l.name===""&&typeof r.uri=="string"&&r.uri.startsWith("data:image/")===!1&&(l.name=r.uri);const d=(i.samplers||{})[o.sampler]||{};return l.magFilter=Nt[d.magFilter]||He,l.minFilter=Nt[d.minFilter]||Qe,l.wrapS=Ft[d.wrapS]||he,l.wrapT=Ft[d.wrapT]||he,l.generateMipmaps=!l.isCompressedTexture&&l.minFilter!==me&&l.minFilter!==He,s.associations.set(l,{textures:e}),l}).catch(function(){return null});return this.textureCache[a]=c,c}loadImageSource(e,t){const n=this,s=this.json,i=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const o=s.images[e],r=self.URL||self.webkitURL;let a=o.uri||"",c=!1;if(o.bufferView!==void 0)a=n.getDependency("bufferView",o.bufferView).then(function(h){c=!0;const d=new Blob([h],{type:o.mimeType});return a=r.createObjectURL(d),a});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then(function(h){return new Promise(function(d,g){let y=d;t.isImageBitmapLoader===!0&&(y=function(m){const p=new wt(m);p.needsUpdate=!0,d(p)}),t.load(De.resolveURL(h,i.path),y,void 0,g)})}).then(function(h){return c===!0&&r.revokeObjectURL(a),le(h,o),h.userData.mimeType=o.mimeType||Gn(o.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),h});return this.sourceCache[e]=l,l}assignTexture(e,t,n,s){const i=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(n.texCoord!==void 0&&n.texCoord>0&&(o=o.clone(),o.channel=n.texCoord),i.extensions[C.KHR_TEXTURE_TRANSFORM]){const r=n.extensions!==void 0?n.extensions[C.KHR_TEXTURE_TRANSFORM]:void 0;if(r){const a=i.associations.get(o);o=i.extensions[C.KHR_TEXTURE_TRANSFORM].extendTexture(o,r),i.associations.set(o,a)}}return s!==void 0&&(o.colorSpace=s),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const s=t.attributes.tangent===void 0,i=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const r="PointsMaterial:"+n.uuid;let a=this.cache.get(r);a||(a=new us,Je.prototype.copy.call(a,n),a.color.copy(n.color),a.map=n.map,a.sizeAttenuation=!1,this.cache.add(r,a)),n=a}else if(e.isLine){const r="LineBasicMaterial:"+n.uuid;let a=this.cache.get(r);a||(a=new We,Je.prototype.copy.call(a,n),a.color.copy(n.color),a.map=n.map,this.cache.add(r,a)),n=a}if(s||i||o){let r="ClonedMaterial:"+n.uuid+":";s&&(r+="derivative-tangents:"),i&&(r+="vertex-colors:"),o&&(r+="flat-shading:");let a=this.cache.get(r);a||(a=n.clone(),i&&(a.vertexColors=!0),o&&(a.flatShading=!0),s&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(r,a),this.associations.set(a,this.associations.get(n))),n=a}e.material=n}getMaterialType(){return xe}loadMaterial(e){const t=this,n=this.json,s=this.extensions,i=n.materials[e];let o;const r={},a=i.extensions||{},c=[];if(a[C.KHR_MATERIALS_UNLIT]){const h=s[C.KHR_MATERIALS_UNLIT];o=h.getMaterialType(),c.push(h.extendParams(r,i,t))}else{const h=i.pbrMetallicRoughness||{};if(r.color=new te(1,1,1),r.opacity=1,Array.isArray(h.baseColorFactor)){const d=h.baseColorFactor;r.color.setRGB(d[0],d[1],d[2],ne),r.opacity=d[3]}h.baseColorTexture!==void 0&&c.push(t.assignTexture(r,"map",h.baseColorTexture,Z)),r.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,r.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(r,"metalnessMap",h.metallicRoughnessTexture)),c.push(t.assignTexture(r,"roughnessMap",h.metallicRoughnessTexture))),o=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(e,r)})))}i.doubleSided===!0&&(r.side=X);const l=i.alphaMode||at.OPAQUE;if(l===at.BLEND?(r.transparent=!0,r.depthWrite=!1):(r.transparent=!1,l===at.MASK&&(r.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&o!==re&&(c.push(t.assignTexture(r,"normalMap",i.normalTexture)),r.normalScale=new K(1,1),i.normalTexture.scale!==void 0)){const h=i.normalTexture.scale;r.normalScale.set(h,h)}if(i.occlusionTexture!==void 0&&o!==re&&(c.push(t.assignTexture(r,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(r.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&o!==re){const h=i.emissiveFactor;r.emissive=new te().setRGB(h[0],h[1],h[2],ne)}return i.emissiveTexture!==void 0&&o!==re&&c.push(t.assignTexture(r,"emissiveMap",i.emissiveTexture,Z)),Promise.all(c).then(function(){const h=new o(r);return i.name&&(h.name=i.name),le(h,i),t.associations.set(h,{materials:e}),i.extensions&&ye(s,h,i),h})}createUniqueName(e){const t=ps.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,s=this.primitiveCache;function i(r){return n[C.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(r,t).then(function(a){return Gt(a,r,t)})}const o=[];for(let r=0,a=e.length;r<a;r++){const c=e[r],l=Fn(c),h=s[l];if(h)o.push(h.promise);else{let d;c.extensions&&c.extensions[C.KHR_DRACO_MESH_COMPRESSION]?d=i(c):d=Gt(new ze,c,t),s[l]={primitive:c,promise:d},o.push(d)}}return Promise.all(o)}loadMesh(e){const t=this,n=this.json,s=this.extensions,i=n.meshes[e],o=i.primitives,r=[];for(let a=0,c=o.length;a<c;a++){const l=o[a].material===void 0?On(this.cache):this.getDependency("material",o[a].material);r.push(l)}return r.push(t.loadGeometries(o)),Promise.all(r).then(function(a){const c=a.slice(0,a.length-1),l=a[a.length-1],h=[];for(let g=0,y=l.length;g<y;g++){const m=l[g],p=o[g];let f;const w=c[g];if(p.mode===ee.TRIANGLES||p.mode===ee.TRIANGLE_STRIP||p.mode===ee.TRIANGLE_FAN||p.mode===void 0)f=i.isSkinnedMesh===!0?new ms(m,w):new E(m,w),f.isSkinnedMesh===!0&&f.normalizeSkinWeights(),p.mode===ee.TRIANGLE_STRIP?f.geometry=Ot(f.geometry,jt):p.mode===ee.TRIANGLE_FAN&&(f.geometry=Ot(f.geometry,ht));else if(p.mode===ee.LINES)f=new Ut(m,w);else if(p.mode===ee.LINE_STRIP)f=new ie(m,w);else if(p.mode===ee.LINE_LOOP)f=new fs(m,w);else if(p.mode===ee.POINTS)f=new gs(m,w);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);Object.keys(f.geometry.morphAttributes).length>0&&Nn(f,i),f.name=t.createUniqueName(i.name||"mesh_"+e),le(f,i),p.extensions&&ye(s,f,p),t.assignFinalMaterial(f),h.push(f)}for(let g=0,y=h.length;g<y;g++)t.associations.set(h[g],{meshes:e,primitives:g});if(h.length===1)return i.extensions&&ye(s,h[0],i),h[0];const d=new Fe;i.extensions&&ye(s,d,i),t.associations.set(d,{meshes:e});for(let g=0,y=h.length;g<y;g++)d.add(h[g]);return d})}loadCamera(e){let t;const n=this.json.cameras[e],s=n[n.type];if(!s){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return n.type==="perspective"?t=new $t(Oe.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):n.type==="orthographic"&&(t=new ys(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),le(t,n),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],n=[];for(let s=0,i=t.joints.length;s<i;s++)n.push(this._loadNodeShallow(t.joints[s]));return t.inverseBindMatrices!==void 0?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(s){const i=s.pop(),o=s,r=[],a=[];for(let c=0,l=o.length;c<l;c++){const h=o[c];if(h){r.push(h);const d=new Ee;i!==null&&d.fromArray(i.array,c*16),a.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new ws(r,a)})}loadAnimation(e){const t=this.json,n=this,s=t.animations[e],i=s.name?s.name:"animation_"+e,o=[],r=[],a=[],c=[],l=[];for(let h=0,d=s.channels.length;h<d;h++){const g=s.channels[h],y=s.samplers[g.sampler],m=g.target,p=m.node,f=s.parameters!==void 0?s.parameters[y.input]:y.input,w=s.parameters!==void 0?s.parameters[y.output]:y.output;m.node!==void 0&&(o.push(this.getDependency("node",p)),r.push(this.getDependency("accessor",f)),a.push(this.getDependency("accessor",w)),c.push(y),l.push(m))}return Promise.all([Promise.all(o),Promise.all(r),Promise.all(a),Promise.all(c),Promise.all(l)]).then(function(h){const d=h[0],g=h[1],y=h[2],m=h[3],p=h[4],f=[];for(let w=0,_=d.length;w<_;w++){const b=d[w],x=g[w],M=y[w],v=m[w],T=p[w];if(b===void 0)continue;b.updateMatrix&&b.updateMatrix();const A=n._createAnimationTracks(b,x,M,v,T);if(A)for(let P=0;P<A.length;P++)f.push(A[P])}return new bs(i,void 0,f)})}createNodeMesh(e){const t=this.json,n=this,s=t.nodes[e];return s.mesh===void 0?null:n.getDependency("mesh",s.mesh).then(function(i){const o=n._getNodeRef(n.meshCache,s.mesh,i);return s.weights!==void 0&&o.traverse(function(r){if(r.isMesh)for(let a=0,c=s.weights.length;a<c;a++)r.morphTargetInfluences[a]=s.weights[a]}),o})}loadNode(e){const t=this.json,n=this,s=t.nodes[e],i=n._loadNodeShallow(e),o=[],r=s.children||[];for(let c=0,l=r.length;c<l;c++)o.push(n.getDependency("node",r[c]));const a=s.skin===void 0?Promise.resolve(null):n.getDependency("skin",s.skin);return Promise.all([i,Promise.all(o),a]).then(function(c){const l=c[0],h=c[1],d=c[2];d!==null&&l.traverse(function(g){g.isSkinnedMesh&&g.bind(d,zn)});for(let g=0,y=h.length;g<y;g++)l.add(h[g]);return l})}_loadNodeShallow(e){const t=this.json,n=this.extensions,s=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const i=t.nodes[e],o=i.name?s.createUniqueName(i.name):"",r=[],a=s._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return a&&r.push(a),i.camera!==void 0&&r.push(s.getDependency("camera",i.camera).then(function(c){return s._getNodeRef(s.cameraCache,i.camera,c)})),s._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){r.push(c)}),this.nodeCache[e]=Promise.all(r).then(function(c){let l;if(i.isBone===!0?l=new _s:c.length>1?l=new Fe:c.length===1?l=c[0]:l=new Ge,l!==c[0])for(let h=0,d=c.length;h<d;h++)l.add(c[h]);if(i.name&&(l.userData.name=i.name,l.name=o),le(l,i),i.extensions&&ye(n,l,i),i.matrix!==void 0){const h=new Ee;h.fromArray(i.matrix),l.applyMatrix4(h)}else i.translation!==void 0&&l.position.fromArray(i.translation),i.rotation!==void 0&&l.quaternion.fromArray(i.rotation),i.scale!==void 0&&l.scale.fromArray(i.scale);return s.associations.has(l)||s.associations.set(l,{}),s.associations.get(l).nodes=e,l}),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],s=this,i=new Fe;n.name&&(i.name=s.createUniqueName(n.name)),le(i,n),n.extensions&&ye(t,i,n);const o=n.nodes||[],r=[];for(let a=0,c=o.length;a<c;a++)r.push(s.getDependency("node",o[a]));return Promise.all(r).then(function(a){for(let l=0,h=a.length;l<h;l++)i.add(a[l]);const c=l=>{const h=new Map;for(const[d,g]of s.associations)(d instanceof Je||d instanceof wt)&&h.set(d,g);return l.traverse(d=>{const g=s.associations.get(d);g!=null&&h.set(d,g)}),h};return s.associations=c(i),i})}_createAnimationTracks(e,t,n,s,i){const o=[],r=e.name?e.name:e.uuid,a=[];pe[i.path]===pe.weights?e.traverse(function(d){d.morphTargetInfluences&&a.push(d.name?d.name:d.uuid)}):a.push(r);let c;switch(pe[i.path]){case pe.weights:c=_t;break;case pe.rotation:c=xt;break;case pe.position:case pe.scale:c=bt;break;default:switch(n.itemSize){case 1:c=_t;break;case 2:case 3:default:c=bt;break}break}const l=s.interpolation!==void 0?kn[s.interpolation]:Vt,h=this._getArrayFromAccessor(n);for(let d=0,g=a.length;d<g;d++){const y=new c(a[d]+"."+pe[i.path],t.array,h,l);s.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(y),o.push(y)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const n=mt(t.constructor),s=new Float32Array(t.length);for(let i=0,o=t.length;i<o;i++)s[i]=t[i]*n;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(n){const s=this instanceof xt?In:Kt;return new s(this.times,this.values,this.getValueSize()/3,n)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function jn(u,e,t){const n=e.attributes,s=new ve;if(n.POSITION!==void 0){const r=t.json.accessors[n.POSITION],a=r.min,c=r.max;if(a!==void 0&&c!==void 0){if(s.set(new S(a[0],a[1],a[2]),new S(c[0],c[1],c[2])),r.normalized){const l=mt(Se[r.componentType]);s.min.multiplyScalar(l),s.max.multiplyScalar(l)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=e.targets;if(i!==void 0){const r=new S,a=new S;for(let c=0,l=i.length;c<l;c++){const h=i[c];if(h.POSITION!==void 0){const d=t.json.accessors[h.POSITION],g=d.min,y=d.max;if(g!==void 0&&y!==void 0){if(a.setX(Math.max(Math.abs(g[0]),Math.abs(y[0]))),a.setY(Math.max(Math.abs(g[1]),Math.abs(y[1]))),a.setZ(Math.max(Math.abs(g[2]),Math.abs(y[2]))),d.normalized){const m=mt(Se[d.componentType]);a.multiplyScalar(m)}r.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(r)}u.boundingBox=s;const o=new Ms;s.getCenter(o.center),o.radius=s.min.distanceTo(s.max)/2,u.boundingSphere=o}function Gt(u,e,t){const n=e.attributes,s=[];function i(o,r){return t.getDependency("accessor",o).then(function(a){u.setAttribute(r,a)})}for(const o in n){const r=pt[o]||o.toLowerCase();r in u.attributes||s.push(i(n[o],r))}if(e.indices!==void 0&&!u.index){const o=t.getDependency("accessor",e.indices).then(function(r){u.setIndex(r)});s.push(o)}return ut.workingColorSpace!==ne&&"COLOR_0"in n&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${ut.workingColorSpace}" not supported.`),le(u,e),jn(u,e,t),Promise.all(s).then(function(){return e.targets!==void 0?Dn(u,e.targets,t):u})}const lt=new WeakMap;class Bn extends Bt{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,n,s){const i=new qe(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,o=>{this.parse(o,t,s)},n,s)}parse(e,t,n=()=>{}){this.decodeDracoFile(e,t,null,null,Z,n).catch(n)}decodeDracoFile(e,t,n,s,i=ne,o=()=>{}){const r={attributeIDs:n||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!n,vertexColorSpace:i};return this.decodeGeometry(e,r).then(t).catch(o)}decodeGeometry(e,t){const n=JSON.stringify(t);if(lt.has(e)){const a=lt.get(e);if(a.key===n)return a.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const i=this.workerNextTaskID++,o=e.byteLength,r=this._getWorker(i,o).then(a=>(s=a,new Promise((c,l)=>{s._callbacks[i]={resolve:c,reject:l},s.postMessage({type:"decode",id:i,taskConfig:t,buffer:e},[e])}))).then(a=>this._createGeometry(a.geometry));return r.catch(()=>!0).then(()=>{s&&i&&this._releaseTask(s,i)}),lt.set(e,{key:n,promise:r}),r}_createGeometry(e){const t=new ze;e.index&&t.setIndex(new Ne(e.index.array,1));for(let n=0;n<e.attributes.length;n++){const s=e.attributes[n],i=s.name,o=s.array,r=s.itemSize,a=new Ne(o,r);i==="color"&&(this._assignVertexColorSpace(a,s.vertexColorSpace),a.normalized=!(o instanceof Float32Array)),t.setAttribute(i,a)}return t}_assignVertexColorSpace(e,t){if(t!==Z)return;const n=new te;for(let s=0,i=e.count;s<i;s++)n.fromBufferAttribute(e,s),ut.toWorkingColorSpace(n,Z),e.setXYZ(s,n.r,n.g,n.b)}_loadLibrary(e,t){const n=new qe(this.manager);return n.setPath(this.decoderPath),n.setResponseType(t),n.setWithCredentials(this.withCredentials),new Promise((s,i)=>{n.load(e,s,void 0,i)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(n=>{const s=n[0];e||(this.decoderConfig.wasmBinary=n[1]);const i=Un.toString(),o=["/* draco decoder */",s,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const s=new Worker(this.workerSourceURL);s._callbacks={},s._taskCosts={},s._taskLoad=0,s.postMessage({type:"init",decoderConfig:this.decoderConfig}),s.onmessage=function(i){const o=i.data;switch(o.type){case"decode":s._callbacks[o.id].resolve(o);break;case"error":s._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(s)}else this.workerPool.sort(function(s,i){return s._taskLoad>i._taskLoad?-1:1});const n=this.workerPool[this.workerPool.length-1];return n._taskCosts[e]=t,n._taskLoad+=t,n})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function Un(){let u,e;onmessage=function(o){const r=o.data;switch(r.type){case"init":u=r.decoderConfig,e=new Promise(function(l){u.onModuleLoaded=function(h){l({draco:h})},DracoDecoderModule(u)});break;case"decode":const a=r.buffer,c=r.taskConfig;e.then(l=>{const h=l.draco,d=new h.Decoder;try{const g=t(h,d,new Int8Array(a),c),y=g.attributes.map(m=>m.array.buffer);g.index&&y.push(g.index.array.buffer),self.postMessage({type:"decode",id:r.id,geometry:g},y)}catch(g){console.error(g),self.postMessage({type:"error",id:r.id,error:g.message})}finally{h.destroy(d)}});break}};function t(o,r,a,c){const l=c.attributeIDs,h=c.attributeTypes;let d,g;const y=r.GetEncodedGeometryType(a);if(y===o.TRIANGULAR_MESH)d=new o.Mesh,g=r.DecodeArrayToMesh(a,a.byteLength,d);else if(y===o.POINT_CLOUD)d=new o.PointCloud,g=r.DecodeArrayToPointCloud(a,a.byteLength,d);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!g.ok()||d.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+g.error_msg());const m={index:null,attributes:[]};for(const p in l){const f=self[h[p]];let w,_;if(c.useUniqueIDs)_=l[p],w=r.GetAttributeByUniqueId(d,_);else{if(_=r.GetAttributeId(d,o[l[p]]),_===-1)continue;w=r.GetAttribute(d,_)}const b=s(o,r,d,p,f,w);p==="color"&&(b.vertexColorSpace=c.vertexColorSpace),m.attributes.push(b)}return y===o.TRIANGULAR_MESH&&(m.index=n(o,r,d)),o.destroy(d),m}function n(o,r,a){const l=a.num_faces()*3,h=l*4,d=o._malloc(h);r.GetTrianglesUInt32Array(a,h,d);const g=new Uint32Array(o.HEAPF32.buffer,d,l).slice();return o._free(d),{array:g,itemSize:1}}function s(o,r,a,c,l,h){const d=h.num_components(),y=a.num_points()*d,m=y*l.BYTES_PER_ELEMENT,p=i(o,l),f=o._malloc(m);r.GetAttributeDataArrayForAllPoints(a,h,p,m,f);const w=new l(o.HEAPF32.buffer,f,y).slice();return o._free(f),{name:c,array:w,itemSize:d}}function i(o,r){switch(r){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}class $n extends As{constructor(e){super(e),this.type=Be}parse(e){const o=function(T,A){switch(T){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(A||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(A||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(A||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(A||""))}},l=`
`,h=function(T,A,P){A=A||1024;let G=T.pos,F=-1,R=0,I="",O=String.fromCharCode.apply(null,new Uint16Array(T.subarray(G,G+128)));for(;0>(F=O.indexOf(l))&&R<A&&G<T.byteLength;)I+=O,R+=O.length,G+=128,O+=String.fromCharCode.apply(null,new Uint16Array(T.subarray(G,G+128)));return-1<F?(T.pos+=R+F+1,I+O.slice(0,F)):!1},d=function(T){const A=/^#\?(\S+)/,P=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,k=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,G=/^\s*FORMAT=(\S+)\s*$/,F=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,R={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let I,O;for((T.pos>=T.byteLength||!(I=h(T)))&&o(1,"no header found"),(O=I.match(A))||o(3,"bad initial token"),R.valid|=1,R.programtype=O[1],R.string+=I+`
`;I=h(T),I!==!1;){if(R.string+=I+`
`,I.charAt(0)==="#"){R.comments+=I+`
`;continue}if((O=I.match(P))&&(R.gamma=parseFloat(O[1])),(O=I.match(k))&&(R.exposure=parseFloat(O[1])),(O=I.match(G))&&(R.valid|=2,R.format=O[1]),(O=I.match(F))&&(R.valid|=4,R.height=parseInt(O[1],10),R.width=parseInt(O[2],10)),R.valid&2&&R.valid&4)break}return R.valid&2||o(3,"missing format specifier"),R.valid&4||o(3,"missing image size specifier"),R},g=function(T,A,P){const k=A;if(k<8||k>32767||T[0]!==2||T[1]!==2||T[2]&128)return new Uint8Array(T);k!==(T[2]<<8|T[3])&&o(3,"wrong scanline width");const G=new Uint8Array(4*A*P);G.length||o(4,"unable to allocate buffer space");let F=0,R=0;const I=4*k,O=new Uint8Array(4),U=new Uint8Array(I);let ce=P;for(;ce>0&&R<T.byteLength;){R+4>T.byteLength&&o(1),O[0]=T[R++],O[1]=T[R++],O[2]=T[R++],O[3]=T[R++],(O[0]!=2||O[1]!=2||(O[2]<<8|O[3])!=k)&&o(3,"bad rgbe scanline format");let j=0,W;for(;j<I&&R<T.byteLength;){W=T[R++];const q=W>128;if(q&&(W-=128),(W===0||j+W>I)&&o(3,"bad scanline data"),q){const se=T[R++];for(let Te=0;Te<W;Te++)U[j++]=se}else U.set(T.subarray(R,R+W),j),j+=W,R+=W}const be=k;for(let q=0;q<be;q++){let se=0;G[F]=U[q+se],se+=k,G[F+1]=U[q+se],se+=k,G[F+2]=U[q+se],se+=k,G[F+3]=U[q+se],F+=4}ce--}return G},y=function(T,A,P,k){const G=T[A+3],F=Math.pow(2,G-128)/255;P[k+0]=T[A+0]*F,P[k+1]=T[A+1]*F,P[k+2]=T[A+2]*F,P[k+3]=1},m=function(T,A,P,k){const G=T[A+3],F=Math.pow(2,G-128)/255;P[k+0]=Ue.toHalfFloat(Math.min(T[A+0]*F,65504)),P[k+1]=Ue.toHalfFloat(Math.min(T[A+1]*F,65504)),P[k+2]=Ue.toHalfFloat(Math.min(T[A+2]*F,65504)),P[k+3]=Ue.toHalfFloat(1)},p=new Uint8Array(e);p.pos=0;const f=d(p),w=f.width,_=f.height,b=g(p.subarray(p.pos),w,_);let x,M,v;switch(this.type){case et:v=b.length/4;const T=new Float32Array(v*4);for(let P=0;P<v;P++)y(b,P*4,T,P*4);x=T,M=et;break;case Be:v=b.length/4;const A=new Uint16Array(v*4);for(let P=0;P<v;P++)m(b,P*4,A,P*4);x=A,M=Be;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:w,height:_,data:x,header:f.string,gamma:f.gamma,exposure:f.exposure,type:M}}setDataType(e){return this.type=e,this}load(e,t,n,s){function i(o,r){switch(o.type){case et:case Be:o.colorSpace=ne,o.minFilter=He,o.magFilter=He,o.generateMipmaps=!1,o.flipY=!0;break}t&&t(o,r)}return super.load(e,i,n,s)}}console.log("lowpoly.js file loaded!");window.onerror=function(u,e,t,n,s){console.error("Global error:",u,"at",e,t,n);const i=document.createElement("div");return i.style.cssText="position:fixed;top:10px;left:10px;right:10px;background:red;color:white;padding:10px;z-index:99999;font-size:12px;word-wrap:break-word;",i.textContent=`Error: ${u} (line ${t})`,document.body.appendChild(i),!1};window.addEventListener("unhandledrejection",function(u){console.error("Unhandled promise rejection:",u.reason);const e=document.createElement("div");e.style.cssText="position:fixed;top:50px;left:10px;right:10px;background:orange;color:black;padding:10px;z-index:99999;font-size:12px;word-wrap:break-word;",e.textContent=`Promise rejected: ${u.reason}`,document.body.appendChild(e)});const L=u=>{const e="/hyundai-lowpoly-toon/",t=u.startsWith("/")?u.slice(1):u;return e+t};class Vn{constructor(){this.container=document.getElementById("game-container"),this.loadingScreen=document.getElementById("loading-screen"),this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.gltfLoader=null,this.dracoLoader=null,this.rgbeLoader=null,this.gridHelper=null,this.sharedGradientMap=null,this.roadTemplates={},this.roadPieces=[],this.roadBaseColorMap=null,this.occupiedCells=new Set,this.GRID_CELL_SIZE=2,this.groundTiles=[],this.TILE_SIZE=10,this.worldGrid=new Map,this.skyboxCubemap=null,this.car=null,this.transformControls=null,this.selectableObjects=[],this.selectedObject=null,this.raycaster=new Ht,this.mouse=new K,this.defaultSceneState=null,this.savedScenes={},this.currentSceneName=null,this.currentCameraViews={Default:null},this.activeCameraView="Default",this.undoHistory=[],this.MAX_UNDO_STEPS=50}async init(){console.log("LowPolyViewer init starting...");try{this.setupRenderer(),console.log("Renderer OK")}catch(i){this.showError("Renderer failed: "+i.message);return}try{this.setupScene(),console.log("Scene OK")}catch(i){this.showError("Scene failed: "+i.message);return}this.setupLoaders(),this.setupLighting(),this.setupControls(),this.setupHelpers(),console.log("Setup complete, loading assets...");try{if(this.isIOS){const i=L("sky_44_2k/sky_44_cubemap_2k/");this.skyboxCubemap=await this.loadSkybox(i,"png"),console.log("Skybox loaded (iOS - smaller png)")}else{const i=L("sky_44_2k/sky_44_cubemap_2k/upscaled/");this.skyboxCubemap=await this.loadSkybox(i,"webp"),console.log("Skybox loaded (webp)")}this.scene.background=this.skyboxCubemap,this.scene.backgroundIntensity=this.isMobile?1.5:1.8,this.scene.fog=new tt(13689087,this.isMobile?30:20,this.isMobile?120:100)}catch(i){console.warn("Skybox failed, using sky color:",i.message),this.scene.background=new te(8900331),this.scene.fog=new tt(8900331,30,150),this.skyboxCubemap=null}const e={apartment1:L("Low%20Poly%20Env%20Exports/apartment1.glb"),autoshop:L("Low%20Poly%20Env%20Exports/autoshop.glb"),building1:L("Low%20Poly%20Env%20Exports/building1.glb"),factory:L("Low%20Poly%20Env%20Exports/factory.glb"),house1:L("Low%20Poly%20Env%20Exports/house1.glb"),house2:L("Low%20Poly%20Env%20Exports/house2.glb"),house3:L("Low%20Poly%20Env%20Exports/house3.glb"),house4:L("Low%20Poly%20Env%20Exports/house4.glb"),nuclearPlant:L("Low%20Poly%20Env%20Exports/nuclearplant.glb"),office:L("Low%20Poly%20Env%20Exports/office.glb"),roadbarrier1:L("Low%20Poly%20Env%20Exports/roadbarrier1.glb"),trafficlight1:L("Low%20Poly%20Env%20Exports/trafficlight1.glb"),tree1:L("Low%20Poly%20Env%20Exports/tree1.glb"),warehouse:L("Low%20Poly%20Env%20Exports/warehouse.glb")},n=[{name:"apartment1_4",type:"apartment1",x:2.86,z:-19.55,rot:-90},{name:"autoshop_4",type:"autoshop",x:3.04,z:-30.38,rot:0},{name:"building1_4",type:"building1",x:-2.87,z:-18.97,rot:90},{name:"factory_4",type:"factory",x:-4.1,z:-45.44,rot:0},{name:"house1_2",type:"house1",x:-2.74,z:-21.62,rot:90},{name:"house2_3",type:"house2",x:2.92,z:-16.23,rot:-90},{name:"house3_1",type:"house3",x:2.99,z:-23.47,rot:-90},{name:"house3_4",type:"house3",x:2.45,z:-34.98,rot:-90},{name:"house4_4",type:"house4",x:-2.64,z:-24.73,rot:90},{name:"nuclearPlant_1",type:"nuclearPlant",x:-6.2,z:-33.7,rot:0},{name:"office_1",type:"office",x:4.38,z:-46.81,rot:0},{name:"office_2",type:"office",x:-4.35,z:-39.92,rot:0},{name:"roadbarrier1_2",type:"roadbarrier1",x:.98,z:-29.45,rot:0},{name:"roadbarrier1_4",type:"roadbarrier1",x:-.94,z:-29.44,rot:0},{name:"roadbarrier1_5",type:"roadbarrier1",x:-.03,z:-29.45,rot:0},{name:"trafficlight1_1",type:"trafficlight1",x:-1.7,z:-25.62,rot:0},{name:"tree1_1",type:"tree1",x:2.34,z:-25.06,rot:0},{name:"tree1_4",type:"tree1",x:2.21,z:-33.35,rot:-90},{name:"warehouse_1",type:"warehouse",x:8.85,z:-33.28,rot:0},{name:"warehouse_3",type:"warehouse",x:5.95,z:-39.84,rot:-90}],s={};for(const i of n){if(!s[i.type]){const r=await this.loadModel(e[i.type]);r&&(this.scene.remove(r),s[i.type]=r)}const o=s[i.type];if(o){const r=o.clone(!0);r.position.set(i.x,0,i.z),r.rotation.y=i.rot*Math.PI/180,this.scene.add(r),this.registerSelectable(r,i.name)}}this.car=await this.loadCar(L("Low%20Poly%20Env%20Exports/car.glb")),this.car&&(this.car.scale.set(.5,.5,.5),this.car.position.x-=8,this.car.position.z+=3,this.registerSelectable(this.car,"car")),this.setupRoadReflectionCamera(),await this.spawnSpineAndBranchSystem3(),this.setupPuddleCubeCamera(),this.spawnPuddles(),this.generateGroundGrid(this.isMobile?10:20),this.spawnUtilityPoles(),this.setupTransformControls(),this.setupSceneManager(),this.setupBuildingSpawner(),this.saveDefaultSceneState(),await this.loadSceneFromURL(),this.hideLoadingScreen(),setTimeout(()=>{this.captureStaticPuddleReflections(),this.captureRoadReflections()},100),this.animate(),document.addEventListener("keydown",i=>{i.code==="KeyG"&&this.toggleGrid(),i.code==="KeyT"&&this.setTransformMode("translate"),i.code==="KeyR"&&this.setTransformMode("rotate"),i.code==="KeyY"&&this.setTransformMode("scale"),i.code==="Escape"&&this.deselectObject(),i.code==="KeyP"&&this.printSelectedPosition(),(i.code==="Delete"||i.code==="Backspace")&&this.deleteSelectedObject(),i.code==="KeyX"&&i.shiftKey&&this.exportRemainingBuildings(),i.shiftKey&&i.code==="KeyC"&&this.resetCameraToOrigin(),i.ctrlKey&&i.code==="KeyZ"&&(i.preventDefault(),this.undo()),(i.code==="Equal"||i.code==="NumpadAdd")&&this.preciseZoom(.1),(i.code==="Minus"||i.code==="NumpadSubtract")&&this.preciseZoom(-.1),i.code==="KeyH"&&this.toggleUI(),i.shiftKey&&this.transformControls&&(this.transformControls.setRotationSnap(Math.PI/2),this.transformControls.setTranslationSnap(1))}),document.addEventListener("keyup",i=>{(i.code==="ShiftLeft"||i.code==="ShiftRight")&&this.transformControls&&(this.transformControls.setRotationSnap(null),this.transformControls.setTranslationSnap(null))}),this.renderer.domElement.addEventListener("click",i=>this.onClickSelect(i)),console.log("%c Low Poly Scene Ready ","background: #74b9ff; color: #000; padding: 4px 8px; border-radius: 4px;"),console.log("Controls: LMB Rotate | MMB Pan | Scroll Zoom | G Grid"),console.log("Transform: Click to select | T Translate | R Rotate | Y Scale | Esc Deselect | P Print position")}setupRenderer(){if(this.isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),this.isIOS=/iPhone|iPad|iPod/i.test(navigator.userAgent),this.renderer=new Ps({antialias:!0,powerPreference:"high-performance"}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.outputColorSpace=Z,this.renderer.toneMapping=Rs,this.renderer.toneMappingExposure=.85,this.renderer.shadowMap.enabled=!this.isMobile,this.renderer.shadowMap.type=Ls,this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",()=>this.onResize()),this.isMobile){console.log("Mobile detected - using performance optimizations");const e=document.getElementById("controls-hint");e&&(e.style.display="none")}}setupScene(){this.scene=new Cs,this.scene.background=new te(8900331),this.scene.fog=new tt(8900331,50,200),this.camera=new $t(80,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(8,2,12),this.camera.lookAt(0,3,0)}setupLoaders(){this.dracoLoader=new Bn,this.dracoLoader.setDecoderPath("https://www.gstatic.com/draco/versioned/decoders/1.5.6/"),this.dracoLoader.setDecoderConfig({type:"js"}),this.gltfLoader=new an,this.gltfLoader.setDRACOLoader(this.dracoLoader),this.rgbeLoader=new $n}setupLighting(){const e=new vs(16777215,2960708,2);this.scene.add(e),this.sun=new dt(16777215,2.5),this.sun.position.set(30,60,20),this.sun.castShadow=!0,this.sun.shadow.mapSize.width=2048,this.sun.shadow.mapSize.height=2048,this.sun.shadow.camera.near=.5,this.sun.shadow.camera.far=500,this.sun.shadow.camera.left=-25,this.sun.shadow.camera.right=25,this.sun.shadow.camera.top=25,this.sun.shadow.camera.bottom=-25,this.sun.shadow.bias=-8e-4,this.sun.shadow.normalBias=.05,this.sun.shadow.radius=4,this.scene.add(this.sun);const t=new dt(16777215,2);t.position.set(-20,30,-30),this.scene.add(t)}setupControls(){this.controls=new Gs(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.1,this.controls.screenSpacePanning=!0,this.controls.minDistance=.5,this.controls.maxDistance=500,this.controls.zoomSpeed=1.5,this.controls.target.set(0,2,0),this.controls.mouseButtons={LEFT:null,MIDDLE:de.ROTATE,RIGHT:de.PAN},this.renderer.domElement.addEventListener("pointerdown",e=>{e.button===0&&e.altKey&&(this.controls.mouseButtons.LEFT=de.ROTATE)},!0),this.renderer.domElement.addEventListener("pointerup",e=>{e.button===0&&(this.controls.mouseButtons.LEFT=null)},!0),this.isMobile?(this.controls.enableZoom=!0,this.controls.zoomSpeed=1,this.controls.touches={ONE:fe.ROTATE,TWO:fe.DOLLY_PAN},console.log("Mobile touch controls enabled: 1-finger rotate, 2-finger zoom/pan"),this.setupMobileZoomButtons()):(this.controls.enableZoom=!1,this.renderer.domElement.addEventListener("wheel",e=>{e.preventDefault();const t=new S;this.camera.getWorldDirection(t);const n=e.ctrlKey?5e-4:.005,s=e.deltaY*n,i=t.multiplyScalar(-s);this.camera.position.add(i),this.controls.target.add(i)},{passive:!1}))}setupTransformControls(){if(this.isMobile){console.log("Mobile detected - skipping transform controls"),this.transformControls=null;return}try{this.transformControls=new qs(this.camera,this.renderer.domElement),this.transformControls.setSize(1),this.transformControls.addEventListener("mouseDown",()=>{this.pushUndoState()}),this.transformControls.addEventListener("dragging-changed",t=>{this.controls.enabled=!t.value});const e=this.transformControls.getHelper();this.scene.add(e),console.log("Transform controls ready")}catch(e){console.error("Failed to setup transform controls:",e),this.transformControls=null}}pushUndoState(){const e=this.captureSceneState();this.undoHistory.push(e),this.undoHistory.length>this.MAX_UNDO_STEPS&&this.undoHistory.shift(),console.log(`Undo state saved (${this.undoHistory.length} steps)`)}undo(){if(this.undoHistory.length===0){console.log("Nothing to undo");return}const e=this.undoHistory.pop();this.applySceneState(e),console.log(`Undo applied (${this.undoHistory.length} steps remaining)`)}setTransformMode(e){this.transformControls&&(this.transformControls.setMode(e),console.log(`Transform mode: ${e}`))}selectObject(e){if(!this.transformControls){console.error("Transform controls not initialized!");return}this.selectedObject=e,this.transformControls.attach(e),this.transformControls.visible=!0,console.log(`Selected: ${e.name||"unnamed"}, transform attached:`,this.transformControls.object===e),console.log("Transform controls visible:",this.transformControls.visible,"in scene:",this.transformControls.parent===this.scene)}deselectObject(){this.selectedObject=null,this.transformControls&&this.transformControls.detach(),console.log("Deselected")}deleteSelectedObject(){if(!this.selectedObject){console.log("Nothing selected to delete");return}const e=this.selectedObject.name||"unnamed object";this.transformControls&&this.transformControls.detach();const t=this.selectableObjects.indexOf(this.selectedObject);t>-1&&this.selectableObjects.splice(t,1),this.scene.remove(this.selectedObject),this.selectedObject.traverse(n=>{n.geometry&&n.geometry.dispose(),n.material&&(Array.isArray(n.material)?n.material.forEach(s=>s.dispose()):n.material.dispose())}),console.log(`Deleted: ${e}`),this.selectedObject=null}exportRemainingBuildings(){const e=this.selectableObjects.filter(t=>t.name&&t.name!=="car").map(t=>({name:t.name,position:{x:Math.round(t.position.x*100)/100,y:Math.round(t.position.y*100)/100,z:Math.round(t.position.z*100)/100},rotation:Math.round(t.rotation.y*180/Math.PI)})).sort((t,n)=>t.name.localeCompare(n.name));console.log("=== SCENE EXPORT (copy this) ==="),console.log(JSON.stringify(e,null,2)),console.log("=== END ===")}onClickSelect(e){if(e.altKey||e.ctrlKey||e.shiftKey||!this.transformControls)return;const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1,console.log(`Click at (${this.mouse.x.toFixed(2)}, ${this.mouse.y.toFixed(2)}), selectables: ${this.selectableObjects.length}`),this.raycaster.setFromCamera(this.mouse,this.camera);const n=this.raycaster.intersectObjects(this.scene.children,!0);if(console.log(`Raycast hits: ${n.length}`),n.length>0)for(const s of n){let i=s.object;for(console.log(`Hit: ${i.name||i.type}, distance: ${s.distance.toFixed(2)}`);i;){if(this.selectableObjects.includes(i)){console.log(`Found selectable: ${i.name}`),this.selectObject(i);return}i=i.parent}}console.log("No selectable hit, deselecting"),this.deselectObject()}printSelectedPosition(){if(this.selectedObject){const e=this.selectedObject.position,t=this.selectedObject.rotation;console.log(`Position: (${e.x.toFixed(2)}, ${e.y.toFixed(2)}, ${e.z.toFixed(2)})`),console.log(`Rotation: (${Oe.radToDeg(t.x).toFixed(1)}, ${Oe.radToDeg(t.y).toFixed(1)}, ${Oe.radToDeg(t.z).toFixed(1)})`)}}registerSelectable(e,t){e.name=t||e.name||"object",this.selectableObjects.push(e)}setupMobileZoomButtons(){const e=document.createElement("div");e.id="mobile-controls",e.style.cssText=`
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    `;const t=`
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      touch-action: manipulation;
      user-select: none;
    `,n=document.createElement("button");n.textContent="+",n.style.cssText=t,n.addEventListener("touchstart",o=>{o.preventDefault(),this.mobileZoom(1)}),n.addEventListener("touchend",()=>this.stopMobileZoom());const s=document.createElement("button");s.textContent="-",s.style.cssText=t,s.addEventListener("touchstart",o=>{o.preventDefault(),this.mobileZoom(-1)}),s.addEventListener("touchend",()=>this.stopMobileZoom());const i=document.createElement("button");i.innerHTML="&#128065;",i.style.cssText=t,i.style.fontSize="20px",this.uiVisible=!0,i.addEventListener("click",()=>{this.uiVisible=!this.uiVisible,["menu-toggle","scene-panel","building-toggle","building-panel","scene-menu","building-menu"].forEach(r=>{const a=document.getElementById(r);a&&(a.style.visibility=this.uiVisible?"visible":"hidden")}),n.style.visibility=this.uiVisible?"visible":"hidden",s.style.visibility=this.uiVisible?"visible":"hidden",i.style.background=this.uiVisible?"rgba(0,0,0,0.6)":"rgba(100,0,0,0.6)"}),e.appendChild(n),e.appendChild(s),e.appendChild(i),document.body.appendChild(e),this.mobileZoomDirection=0,this.mobileZoomInterval=null}mobileZoom(e){this.mobileZoomDirection=e,!this.mobileZoomInterval&&(this.mobileZoomInterval=setInterval(()=>{const t=new S;this.camera.getWorldDirection(t);const n=.04;this.camera.position.addScaledVector(t,n*this.mobileZoomDirection),this.controls.target.addScaledVector(t,n*this.mobileZoomDirection)},16))}stopMobileZoom(){this.mobileZoomDirection=0,this.mobileZoomInterval&&(clearInterval(this.mobileZoomInterval),this.mobileZoomInterval=null)}setupSceneManager(){const e=localStorage.getItem("lowpoly_scenes");e&&(this.savedScenes=JSON.parse(e));const t=document.getElementById("menu-toggle"),n=document.getElementById("scene-panel");t.addEventListener("click",()=>{n.style.display=n.style.display==="none"?"block":"none"}),document.getElementById("save-scene-btn").addEventListener("click",()=>{const a=document.getElementById("scene-name-input"),c=a.value.trim()||`Scene ${Object.keys(this.savedScenes).length+1}`;this.saveScene(c),a.value=""}),document.getElementById("default-scene-btn").addEventListener("click",()=>{this.loadDefaultScene()});const s=document.getElementById("share-scene-btn");s&&s.addEventListener("click",()=>this.shareScene());const i=document.getElementById("push-github-btn");i&&i.addEventListener("click",()=>this.pushToGitHub());const o=document.getElementById("clear-token-btn");o&&o.addEventListener("click",()=>this.clearGitHubToken());const r=document.getElementById("save-camera-btn");r&&r.addEventListener("click",()=>this.saveCameraView()),this.renderSceneList(),this.renderCameraViewList()}setupBuildingSpawner(){this.buildingPaths={house1:L("Low%20Poly%20Env%20Exports/house1.glb"),house2:L("Low%20Poly%20Env%20Exports/house2.glb"),house3:L("Low%20Poly%20Env%20Exports/house3.glb"),nuclearplant:L("Low%20Poly%20Env%20Exports/nuclearplant.glb"),warehouse:L("Low%20Poly%20Env%20Exports/warehouse.glb"),office:L("Low%20Poly%20Env%20Exports/office.glb"),tree1:L("Low%20Poly%20Env%20Exports/tree1.glb"),trafficlight1:L("Low%20Poly%20Env%20Exports/trafficlight1.glb"),roadbarrier1:L("Low%20Poly%20Env%20Exports/roadbarrier1.glb"),apartment1:L("Low%20Poly%20Env%20Exports/apartment1.glb"),building1:L("Low%20Poly%20Env%20Exports/building1.glb"),house4:L("Low%20Poly%20Env%20Exports/house4.glb"),autoshop:L("Low%20Poly%20Env%20Exports/autoshop.glb"),factory:L("Low%20Poly%20Env%20Exports/factory.glb")};const e=document.getElementById("building-toggle"),t=document.getElementById("building-panel");e.addEventListener("click",()=>{t.style.display=t.style.display==="none"?"block":"none"}),document.querySelectorAll(".spawn-building-btn").forEach(n=>{n.addEventListener("click",()=>{this.spawnBuilding(n.dataset.building)})})}async spawnBuilding(e){const t=this.buildingPaths[e];if(!t){console.error(`Unknown building type: ${e}`);return}this.pushUndoState();const n=await this.loadModel(t);if(n){n.position.copy(this.controls.target),n.position.y=0,n.userData.spawnedType=e;const s=this.selectableObjects.filter(o=>o.name.startsWith(e)).length+1,i=`${e}_${s}`;this.registerSelectable(n,i),this.selectObject(n),console.log(`Spawned ${i} at (${n.position.x.toFixed(1)}, ${n.position.z.toFixed(1)})`)}}saveDefaultSceneState(){this.defaultSceneState=this.captureSceneState(),console.log("Default scene state saved")}captureCameraState(){return{position:{x:this.camera.position.x,y:this.camera.position.y,z:this.camera.position.z},target:{x:this.controls.target.x,y:this.controls.target.y,z:this.controls.target.z},zoom:this.camera.zoom}}applyCameraState(e){e&&(e.position&&this.camera.position.set(e.position.x,e.position.y,e.position.z),e.target&&this.controls.target.set(e.target.x,e.target.y,e.target.z),e.zoom!==void 0&&(this.camera.zoom=e.zoom,this.camera.updateProjectionMatrix()),this.controls.update())}captureSceneState(){const e={transforms:{},spawned:[],cameraViews:this.currentCameraViews||{Default:this.captureCameraState()},activeCameraView:this.activeCameraView||"Default"};return e.cameraViews[e.activeCameraView]=this.captureCameraState(),this.selectableObjects.forEach(t=>{e.transforms[t.name]={position:{x:t.position.x,y:t.position.y,z:t.position.z},rotation:{x:t.rotation.x,y:t.rotation.y,z:t.rotation.z},scale:{x:t.scale.x,y:t.scale.y,z:t.scale.z}},t.userData.spawnedType&&e.spawned.push({name:t.name,type:t.userData.spawnedType})}),e}async applySceneState(e){const t=e.transforms||e,n=e.spawned||[],s=n.map(o=>o.name);this.selectableObjects.filter(o=>o.userData.spawnedType&&!s.includes(o.name)).forEach(o=>{this.scene.remove(o);const r=this.selectableObjects.indexOf(o);r>-1&&this.selectableObjects.splice(r,1)});for(const o of n)if(!this.selectableObjects.find(a=>a.name===o.name)&&this.buildingPaths[o.type]){const a=await this.loadModel(this.buildingPaths[o.type]);a&&(a.userData.spawnedType=o.type,this.registerSelectable(a,o.name))}this.selectableObjects.forEach(o=>{const r=t[o.name];r&&(o.position.set(r.position.x,r.position.y,r.position.z),o.rotation.set(r.rotation.x,r.rotation.y,r.rotation.z),o.scale.set(r.scale.x,r.scale.y,r.scale.z))}),e.cameraViews?(this.currentCameraViews=e.cameraViews,this.activeCameraView=e.activeCameraView||Object.keys(e.cameraViews)[0]||"Default",this.applyCameraState(e.cameraViews[this.activeCameraView]),this.renderCameraViewList()):e.camera&&(this.currentCameraViews={Default:e.camera},this.activeCameraView="Default",this.applyCameraState(e.camera),this.renderCameraViewList())}saveCameraView(e){if(!this.currentSceneName){alert(`Please save or load a scene first.

Camera views are saved per-scene.`);return}!e&&(e=prompt("Enter camera view name:",`View ${Object.keys(this.currentCameraViews||{}).length+1}`),!e)||(this.currentCameraViews||(this.currentCameraViews={}),this.currentCameraViews[e]=this.captureCameraState(),this.activeCameraView=e,this.savedScenes[this.currentSceneName]=this.captureSceneState(),localStorage.setItem("lowpoly_scenes",JSON.stringify(this.savedScenes)),console.log(`Camera view "${e}" saved to scene "${this.currentSceneName}"`),this.renderCameraViewList())}loadCameraView(e){this.currentCameraViews&&this.currentCameraViews[e]&&(this.activeCameraView&&this.currentCameraViews[this.activeCameraView]&&(this.currentCameraViews[this.activeCameraView]=this.captureCameraState()),this.activeCameraView=e,this.applyCameraState(this.currentCameraViews[e]),console.log(`Camera view loaded: ${e}`),this.renderCameraViewList())}deleteCameraView(e){if(this.currentSceneName&&this.currentCameraViews&&this.currentCameraViews[e]){if(delete this.currentCameraViews[e],this.activeCameraView===e){const t=Object.keys(this.currentCameraViews);this.activeCameraView=t[0]||"Default",t.length===0&&(this.currentCameraViews.Default=this.captureCameraState())}this.savedScenes[this.currentSceneName]=this.captureSceneState(),localStorage.setItem("lowpoly_scenes",JSON.stringify(this.savedScenes)),console.log(`Camera view "${e}" deleted from scene "${this.currentSceneName}"`),this.renderCameraViewList()}}renderCameraViewList(){const e=document.getElementById("camera-views-list"),t=document.getElementById("camera-views-header"),n=document.getElementById("save-camera-btn");if(!e)return;if(t&&(this.currentSceneName?t.innerHTML=`Camera Views <span style="color:#3498db;">(${this.currentSceneName})</span>`:t.innerHTML='Camera Views <span style="color:#666;">(no scene)</span>'),n&&(this.currentSceneName?(n.disabled=!1,n.style.opacity="1",n.style.cursor="pointer"):(n.disabled=!0,n.style.opacity="0.5",n.style.cursor="not-allowed")),!this.currentSceneName){e.innerHTML='<div style="color:#666;font-size:10px;text-align:center;">Load a scene first</div>';return}const s=Object.keys(this.currentCameraViews||{});if(s.length===0){e.innerHTML='<div style="color:#666;font-size:10px;text-align:center;">No camera views</div>';return}e.innerHTML=s.map(i=>{const o=i===this.activeCameraView;return`
        <div style="display:flex;align-items:center;margin-bottom:3px;">
          <button class="cam-view-btn" data-view="${i}" style="flex:1;background:${o?"#3498db":"#444"};color:#fff;border:none;padding:4px 6px;border-radius:3px;cursor:pointer;text-align:left;font-size:10px;">${i}</button>
          <button class="cam-view-delete" data-view="${i}" style="background:#c0392b;color:#fff;border:none;padding:4px 6px;border-radius:3px;cursor:pointer;margin-left:3px;font-size:9px;">X</button>
        </div>
      `}).join(""),e.querySelectorAll(".cam-view-btn").forEach(i=>{i.addEventListener("click",()=>this.loadCameraView(i.dataset.view))}),e.querySelectorAll(".cam-view-delete").forEach(i=>{i.addEventListener("click",()=>this.deleteCameraView(i.dataset.view))})}saveScene(e){const t=this.captureSceneState();this.savedScenes[e]=t,this.currentSceneName=e,localStorage.setItem("lowpoly_scenes",JSON.stringify(this.savedScenes)),console.log(`Scene saved: ${e}`),this.renderSceneList()}async loadScene(e){const t=this.savedScenes[e];t&&(await this.applySceneState(t),this.currentSceneName=e,console.log(`Scene loaded: ${e}`),this.renderSceneList(),this.renderCameraViewList())}async loadDefaultScene(){this.defaultSceneState&&(await this.applySceneState(this.defaultSceneState),this.currentSceneName=null,this.currentCameraViews={Default:this.captureCameraState()},this.activeCameraView="Default",console.log("Default scene loaded"),this.renderSceneList(),this.renderCameraViewList())}deleteScene(e){delete this.savedScenes[e],localStorage.setItem("lowpoly_scenes",JSON.stringify(this.savedScenes)),this.currentSceneName===e&&(this.currentSceneName=null),console.log(`Scene deleted: ${e}`),this.renderSceneList()}overwriteScene(e){const t=this.captureSceneState();this.savedScenes[e]=t,this.currentSceneName=e,localStorage.setItem("lowpoly_scenes",JSON.stringify(this.savedScenes)),console.log(`Scene overwritten: ${e}`),this.renderSceneList()}renderSceneList(){const e=document.getElementById("saved-scenes-list"),t=Object.keys(this.savedScenes);if(t.length===0){e.innerHTML='<div style="color:#666;font-size:11px;text-align:center;">No saved scenes</div>';return}e.innerHTML=t.map(n=>{const s=n===this.currentSceneName;return`
        <div style="display:flex;align-items:center;margin-bottom:4px;">
          <button class="scene-load-btn" data-scene="${n}" style="flex:1;background:${s?"#74b9ff":"#555"};color:${s?"#000":"#fff"};border:none;padding:6px 8px;border-radius:4px;cursor:pointer;text-align:left;font-size:11px;">${n}</button>
          <button class="scene-overwrite-btn" data-scene="${n}" style="background:#f39c12;color:#000;border:none;padding:6px 8px;border-radius:4px;cursor:pointer;margin-left:4px;font-size:10px;" title="Overwrite">S</button>
          <button class="scene-delete-btn" data-scene="${n}" style="background:#e74c3c;color:#fff;border:none;padding:6px 8px;border-radius:4px;cursor:pointer;margin-left:4px;font-size:10px;">X</button>
        </div>
      `}).join(""),e.querySelectorAll(".scene-load-btn").forEach(n=>{n.addEventListener("click",()=>this.loadScene(n.dataset.scene))}),e.querySelectorAll(".scene-overwrite-btn").forEach(n=>{n.addEventListener("click",()=>this.overwriteScene(n.dataset.scene))}),e.querySelectorAll(".scene-delete-btn").forEach(n=>{n.addEventListener("click",()=>this.deleteScene(n.dataset.scene))})}shareScene(){const e=this.captureSceneState(),t=JSON.stringify(e),n=btoa(encodeURIComponent(t)),i=`${window.location.origin+window.location.pathname}?scene=${n}`;return navigator.clipboard.writeText(i).then(()=>{alert(`Share URL copied to clipboard!

Paste this URL to load the scene on any device.`),console.log("Share URL:",i)}).catch(o=>{prompt("Copy this URL to share your scene:",i)}),i}async loadSceneFromURL(){const t=new URLSearchParams(window.location.search).get("scene");if(t)try{const n=decodeURIComponent(atob(t)),s=JSON.parse(n);await this.applySceneState(s),console.log("Scene loaded from URL");const i=window.location.origin+window.location.pathname;return window.history.replaceState({},document.title,i),!0}catch(n){console.error("Failed to load scene from URL:",n)}try{const n=L("presets/scenes.json");console.log("Loading scenes from:",n);const s=await fetch(n),i=s.headers.get("content-type");if(s.ok&&i&&i.includes("application/json")){const o=await s.json();if(o.savedScenes&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?this.savedScenes={...o.savedScenes,...this.savedScenes}:this.savedScenes=o.savedScenes,this.renderSceneList(),console.log("Loaded saved scenes:",Object.keys(this.savedScenes))),o.currentScene)return await this.applySceneState(o.currentScene),console.log("Current scene loaded from preset"),!0}}catch(n){console.warn("scenes.json not available:",n.message)}try{const n=L("presets/game-scene-1.json");console.log("Loading default preset:",n);const s=await fetch(n),i=s.headers.get("content-type");if(s.ok&&i&&i.includes("application/json")){const o=await s.json();return await this.applySceneState(o),this.currentSceneName="Game Scene 1",this.renderSceneList(),this.renderCameraViewList(),console.log("Game Scene 1 loaded as default"),!0}}catch(n){console.error("Failed to load preset scene:",n)}return!1}getGitHubToken(){return localStorage.getItem("github_token")}setGitHubToken(e){e?localStorage.setItem("github_token",e):localStorage.removeItem("github_token")}async pushToGitHub(){const e=this.getGitHubToken();if(!e){const i=prompt(`Enter your GitHub Personal Access Token:

Create one at: https://github.com/settings/tokens/new
Required scope: "repo" (Full control of private repositories)

The token will be stored locally in your browser.`);return i?(this.setGitHubToken(i),this.pushToGitHub()):(alert("GitHub token is required to push changes."),!1)}const t="creativehubiion",n="hyundai-lowpoly-toon",s="master";try{const i=this.captureSceneState(),o={currentScene:i,savedScenes:this.savedScenes,lastUpdated:new Date().toISOString()};return await this.pushFileToGitHub(e,t,n,s,"assets/presets/scenes.json",JSON.stringify(o,null,2),"Update all scenes data"),await this.pushFileToGitHub(e,t,n,s,"assets/presets/game-scene-1.json",JSON.stringify(i,null,2),"Update default scene preset"),alert(`All scenes pushed to GitHub successfully!

The site will update after GitHub Pages rebuilds (1-2 minutes).`),console.log("Scenes pushed to GitHub"),!0}catch(i){return console.error("GitHub push failed:",i),i.message.includes("401")?(this.setGitHubToken(null),alert("GitHub token is invalid or expired. Please enter a new one."),this.pushToGitHub()):(alert(`Failed to push to GitHub:
${i.message}`),!1)}}async pushFileToGitHub(e,t,n,s,i,o,r){const a=btoa(unescape(encodeURIComponent(o))),c=await fetch(`https://api.github.com/repos/${t}/${n}/contents/${i}?ref=${s}`,{headers:{Authorization:`token ${e}`,Accept:"application/vnd.github.v3+json"}});let l=null;c.ok&&(l=(await c.json()).sha);const h=await fetch(`https://api.github.com/repos/${t}/${n}/contents/${i}`,{method:"PUT",headers:{Authorization:`token ${e}`,Accept:"application/vnd.github.v3+json","Content-Type":"application/json"},body:JSON.stringify({message:`${r}

Pushed from Low Poly Toon Viewer`,content:a,sha:l,branch:s})});if(!h.ok){const d=await h.json();throw new Error(d.message||`Failed to push ${i}`)}return!0}clearGitHubToken(){this.setGitHubToken(null),alert("GitHub token cleared. You will be prompted for a new token on next push.")}spawnStreetLight(e,t,n=1){const s=new Fe,i=new $(.05,.08,3,8),o=new Q({color:3815994,gradientMap:this.sharedGradientMap}),r=new E(i,o);r.position.y=1.5,r.castShadow=!0,s.add(r);const a=new $(.03,.03,1.2,6),c=new E(a,o);c.rotation.z=Math.PI/2,c.position.set(n*.5,2.8,0),c.castShadow=!0,s.add(c);const l=new V(.3,.15,.5),h=new Q({color:5592405,gradientMap:this.sharedGradientMap}),d=new E(l,h);d.position.set(n*1,2.7,0),d.castShadow=!0,s.add(d);const g=new Ke(.25,.4),y=new re({color:16775904,side:X}),m=new E(g,y);m.rotation.x=Math.PI/2,m.position.set(n*1,2.6,0),s.add(m);const p=this.createOutline(r,.02);return r.add(p),s.position.set(e,0,t),this.scene.add(s),s}spawnStreetLights(e,t=10){console.log(`Spawning street lights every ${t} units...`);const n=3;for(let s=5;s<e*.5;s+=t)this.spawnStreetLight(-n,s,-1),this.spawnStreetLight(n,s,1);console.log("Street lights spawned")}spawnUtilityPoles(){this.utilityPoles||(this.utilityPoles=[]),this.utilityPoles.forEach(s=>this.scene.remove(s)),this.utilityPoles=[];const e=20,t=3.5,n=[];for(let s=0;s>-80;s-=e)n.push({x:t,z:s});n.forEach((s,i)=>{const o=this.createUtilityPole(s.x,s.z);if(this.utilityPoles.push(o),i<n.length-1){const r=n[i+1];this.createSaggingCables(s.x,s.z,r.x,r.z)}}),console.log(`Spawned ${this.utilityPoles.length} utility poles with cables`)}createUtilityPole(e,t){const n=new Fe,s=new $(.08,.1,8,8),i=new Q({color:4865066,gradientMap:this.sharedGradientMap}),o=new E(s,i);o.position.y=4,o.castShadow=!0,o.receiveShadow=!0,n.add(o);const r=new V(2,.1,.1),a=new E(r,i);a.position.y=7.5,n.add(a);const c=new $(.03,.04,.15,6),l=new Q({color:3355443,gradientMap:this.sharedGradientMap});[-.7,0,.7].forEach(d=>{const g=new E(c,l);g.position.set(d,7.6,0),n.add(g)});const h=this.createOutline(o,.015);return o.add(h),n.position.set(e,0,t),this.scene.add(n),n}createSaggingCables(e,t,n,s){const i=new We({color:0}),o=7.6,r=[-.7,0,.7],a=1.2;r.forEach(c=>{const l=[];for(let y=0;y<=24;y++){const m=y/24,p=e+c,f=t+(s-t)*m,w=a*4*m*(1-m),_=o-w;l.push(new S(p,_,f))}const d=new ze().setFromPoints(l),g=new ie(d,i);this.scene.add(g),this.utilityPoles.push(g)})}createPuddleAlphaMap(e=0){const n=document.createElement("canvas");n.width=128,n.height=128;const s=n.getContext("2d"),i=()=>(e=(e*9301+49297)%233280,e/233280);s.fillStyle="#000",s.fillRect(0,0,128,128);const o=128/2,r=128/2,a=128*.35,c=5+Math.floor(i()*4);for(let d=0;d<c;d++){const g=d/c*Math.PI*2+i()*.5,y=i()*a*.3,m=o+Math.cos(g)*y,p=r+Math.sin(g)*y,f=a*(.6+i()*.5),w=s.createRadialGradient(m,p,0,m,p,f);w.addColorStop(0,"rgba(255,255,255,1)"),w.addColorStop(.5,"rgba(255,255,255,0.9)"),w.addColorStop(.75,"rgba(255,255,255,0.5)"),w.addColorStop(1,"rgba(255,255,255,0)"),s.fillStyle=w,s.beginPath(),s.arc(m,p,f,0,Math.PI*2),s.fill()}const l=2+Math.floor(i()*3);for(let d=0;d<l;d++){const g=i()*Math.PI*2,y=a*(.7+i()*.4),m=o+Math.cos(g)*y,p=r+Math.sin(g)*y,f=a*(.2+i()*.25),w=s.createRadialGradient(m,p,0,m,p,f);w.addColorStop(0,"rgba(255,255,255,0.8)"),w.addColorStop(.6,"rgba(255,255,255,0.4)"),w.addColorStop(1,"rgba(255,255,255,0)"),s.fillStyle=w,s.beginPath(),s.arc(m,p,f,0,Math.PI*2),s.fill()}const h=new Ae(n);return h.needsUpdate=!0,h}createWaterNormalMap(){const t=document.createElement("canvas");t.width=128,t.height=128;const n=t.getContext("2d"),s=n.createImageData(128,128),i=s.data;for(let r=0;r<128;r++)for(let a=0;a<128;a++){const c=(r*128+a)*4,l=Math.sin(a*.15)*Math.cos(r*.12)*.3,h=Math.sin(a*.08+r*.1)*.2,d=Math.sin(a*.2-r*.15)*.15,g=l+h+d,y=128+g*40,m=128+g*40,p=255;i[c]=Math.max(0,Math.min(255,y)),i[c+1]=Math.max(0,Math.min(255,m)),i[c+2]=p,i[c+3]=255}n.putImageData(s,0,0);const o=new Ae(t);return o.wrapS=he,o.wrapT=he,o.needsUpdate=!0,o}setupPuddleCubeCamera(){if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent))return console.log("Mobile detected - skipping CubeCamera for performance"),this.puddleCubeCamera=null,this.waterNormalMap=this.createWaterNormalMap(),this.puddleReflectionCaptured=!0,null;try{const t=new St(256,{format:Pe,generateMipmaps:!0,minFilter:Qe});return this.puddleCubeCamera=new Et(.1,150,t),this.puddleCubeCamera.position.set(0,.5,-25),this.scene.add(this.puddleCubeCamera),this.waterNormalMap=this.createWaterNormalMap(),this.puddleReflectionCaptured=!1,console.log("Puddle CubeCamera ready (static mode)"),t.texture}catch(t){return console.warn("CubeCamera failed, using skybox fallback:",t),this.puddleCubeCamera=null,this.waterNormalMap=this.createWaterNormalMap(),this.puddleReflectionCaptured=!0,null}}setupRoadReflectionCamera(){try{const e=new St(256,{format:Pe,generateMipmaps:!0,minFilter:Qe});return this.roadCubeCamera=new Et(.1,200,e),this.roadCubeCamera.position.set(0,.3,-25),this.scene.add(this.roadCubeCamera),this.roadReflectionCaptured=!1,console.log("Road reflection CubeCamera ready (256x256, single snapshot)"),e.texture}catch(e){return console.warn("Road CubeCamera failed:",e),this.roadCubeCamera=null,null}}captureRoadReflections(){!this.roadCubeCamera||this.roadReflectionCaptured||(console.log("Capturing road building reflections (single snapshot)..."),this.roadMeshes&&this.roadMeshes.forEach(e=>e.visible=!1),this.roadCubeCamera.update(this.renderer,this.scene),this.roadMeshes&&this.roadMeshes.forEach(e=>e.visible=!0),this.roadReflectionCaptured=!0,console.log("Road reflections captured (no further updates)"))}captureStaticPuddleReflections(){!this.puddleCubeCamera||this.puddleReflectionCaptured||(console.log("Capturing static puddle reflections..."),console.log("  Buildings visible:",this.selectableObjects.length),this.puddles&&this.puddles.forEach(e=>e.visible=!1),this.groundTiles&&this.groundTiles.forEach(e=>e.visible=!1),this.roadPieces&&this.roadPieces.forEach(e=>e.visible=!1),this.gridHelper&&(this.gridHelper.visible=!1),this.streetLights&&this.streetLights.forEach(e=>e.visible=!1),this.selectableObjects.forEach(e=>e.visible=!0),this.puddleCubeCamera.position.set(0,.3,-20),this.puddleCubeCamera.update(this.renderer,this.scene),this.puddles&&this.puddles.forEach(e=>e.visible=!0),this.groundTiles&&this.groundTiles.forEach(e=>e.visible=!0),this.roadPieces&&this.roadPieces.forEach(e=>e.visible=!0),this.streetLights&&this.streetLights.forEach(e=>e.visible=!0),this.puddleReflectionCaptured=!0,console.log("Static puddle reflections captured (no further updates)"))}spawnPuddle(e,t,n=1,s=0){const i=new Ke(2,2);i.rotateX(-Math.PI/2);const o=this.createPuddleAlphaMap(Math.random()*1e4),r=this.puddleCubeCamera?this.puddleCubeCamera.renderTarget.texture:this.skyboxCubemap,a=new xe({color:2236962,envMap:r,envMapIntensity:4,roughness:0,metalness:1,normalMap:this.waterNormalMap,normalScale:new K(.07,.07),transparent:!0,opacity:.4,alphaMap:o,side:X,depthWrite:!1}),c=new E(i,a);return c.position.set(e,.02,t),c.rotation.y=s,c.scale.set(n,1,n),c.castShadow=!1,c.receiveShadow=!0,c.renderOrder=1,c.userData.isPuddle=!0,this.scene.add(c),this.puddles||(this.puddles=[]),this.puddles.push(c),c}spawnPuddles(){console.log("Spawning puddles... skyboxCubemap:",this.skyboxCubemap?"exists":"null"),this.puddles&&(this.puddles.forEach(t=>this.scene.remove(t)),this.puddles=[]),[{x:-.5,z:-17,scale:1.2,rot:Math.random()*Math.PI},{x:.8,z:-19,scale:.8,rot:Math.random()*Math.PI},{x:-1.2,z:-20,scale:1,rot:Math.random()*Math.PI},{x:.3,z:-23,scale:.7,rot:Math.random()*Math.PI},{x:-.8,z:-26,scale:.9,rot:Math.random()*Math.PI},{x:.5,z:-30,scale:1.1,rot:Math.random()*Math.PI},{x:1.5,z:-33,scale:.6,rot:Math.random()*Math.PI},{x:-1,z:-38,scale:.8,rot:Math.random()*Math.PI}].forEach(t=>{this.spawnPuddle(t.x,t.z,t.scale,t.rot),console.log(`Puddle at (${t.x}, ${t.z}), scale: ${t.scale}`)}),console.log(`Spawned ${this.puddles.length} puddles`)}boostTextureContrast(e,t=1.5){if(!e||!e.image)return null;try{const n=document.createElement("canvas"),s=n.getContext("2d");n.width=e.image.width||512,n.height=e.image.height||512,s.drawImage(e.image,0,0,n.width,n.height);const i=s.getImageData(0,0,n.width,n.height),o=i.data;for(let a=0;a<o.length;a+=4)o[a]=Math.max(0,Math.min(255,(o[a]-128)*t+128)),o[a+1]=Math.max(0,Math.min(255,(o[a+1]-128)*t+128)),o[a+2]=Math.max(0,Math.min(255,(o[a+2]-128)*t+128));s.putImageData(i,0,0);const r=new Ae(n);return r.wrapS=e.wrapS,r.wrapT=e.wrapT,r.repeat.copy(e.repeat),r.colorSpace=Z,console.log("Road texture contrast boosted by",t),r}catch(n){return console.warn("Could not boost texture contrast:",n),null}}createRoadBumpMap(){const t=document.createElement("canvas");t.width=512,t.height=512;const n=t.getContext("2d");n.fillStyle="#808080",n.fillRect(0,0,512,512);const s=n.getImageData(0,0,512,512),i=s.data;for(let r=0;r<512;r++)for(let a=0;a<512;a++){const c=(r*512+a)*4,l=(Math.random()-.5)*60,h=(Math.sin(a*.3)*Math.cos(r*.3)+Math.random()-.5)*30,d=Math.sin(a*.05+Math.random())*Math.cos(r*.05)*20,g=l+h+d,y=Math.max(0,Math.min(255,128+g));i[c]=y,i[c+1]=y,i[c+2]=y}n.putImageData(s,0,0);for(let r=0;r<50;r++){const a=Math.random()*512,c=Math.random()*512,l=Math.random()*8+2,h=n.createRadialGradient(a,c,0,a,c,l);h.addColorStop(0,"rgba(40,40,40,0.5)"),h.addColorStop(1,"rgba(128,128,128,0)"),n.beginPath(),n.arc(a,c,l,0,Math.PI*2),n.fillStyle=h,n.fill()}for(let r=0;r<100;r++){const a=Math.random()*512,c=Math.random()*512,l=Math.random()*3+1,h=n.createRadialGradient(a,c,0,a,c,l);h.addColorStop(0,"rgba(200,200,200,0.6)"),h.addColorStop(1,"rgba(128,128,128,0)"),n.beginPath(),n.arc(a,c,l,0,Math.PI*2),n.fillStyle=h,n.fill()}const o=new Ae(t);return o.wrapS=he,o.wrapT=he,o.repeat.set(1,4),o}createAsphaltTexture(){const t=document.createElement("canvas");t.width=256,t.height=256;const n=t.getContext("2d");n.fillStyle="#1a1a1a",n.fillRect(0,0,256,256);const s=n.getImageData(0,0,256,256),i=s.data;for(let r=0;r<i.length;r+=4){const a=(Math.random()-.5)*10;i[r]=Math.max(0,Math.min(255,i[r]+a)),i[r+1]=Math.max(0,Math.min(255,i[r+1]+a)),i[r+2]=Math.max(0,Math.min(255,i[r+2]+a))}n.putImageData(s,0,0);for(let r=0;r<20;r++){const a=Math.random()*256,c=Math.random()*256,l=Math.random()*5+2;n.beginPath(),n.arc(a,c,l,0,Math.PI*2),n.fillStyle=`rgba(0,0,0,${Math.random()*.2})`,n.fill()}const o=new Ae(t);return o.wrapS=he,o.wrapT=he,o.repeat.set(4,4),o}setupHelpers(){this.gridHelper=new Is(50,50,16777215,16777215),this.gridHelper.material.opacity=.15,this.gridHelper.material.transparent=!0,this.gridHelper.visible=!1,this.scene.add(this.gridHelper),this.axesHelper=new ks(5),this.axesHelper.visible=!1,this.scene.add(this.axesHelper)}getGridKey(e,t){const n=Math.round(e/this.TILE_SIZE),s=Math.round(t/this.TILE_SIZE);return`${n},${s}`}snapToGrid(e){return Math.round(e/this.TILE_SIZE)*this.TILE_SIZE}isGridOccupied(e,t){const n=`${e},${t}`;return this.worldGrid.has(n)}removeTileAt(e,t){const n=`${e},${t}`,s=this.worldGrid.get(n);if(s){this.scene.remove(s.mesh),s.mesh.geometry.dispose(),s.mesh.material.dispose(),this.worldGrid.delete(n);const i=this.groundTiles.indexOf(s.mesh);return i>-1&&this.groundTiles.splice(i,1),!0}return!1}spawnGrassTile(e,t){const n=`${e},${t}`;if(this.worldGrid.has(n))return null;this.sharedGradientMap||(this.sharedGradientMap=this.createToonGradientMap());const s=new Ke(this.TILE_SIZE,this.TILE_SIZE),i=new Q({color:7908166,gradientMap:this.sharedGradientMap,side:X});i.emissive=new te(1715738),i.emissiveIntensity=1;const o=new E(s,i);return o.rotation.x=-Math.PI/2,o.position.set(e*this.TILE_SIZE,-.01,t*this.TILE_SIZE),o.receiveShadow=!0,o.castShadow=!1,this.scene.add(o),this.groundTiles.push(o),this.worldGrid.set(n,{type:"grass",mesh:o}),o}generateGroundGrid(e=20){console.log(`Generating ${e}x${e} ground grid...`),this.groundTiles.forEach(n=>{this.scene.remove(n),n.geometry.dispose(),n.material.dispose()}),this.groundTiles=[],this.worldGrid.clear();const t=Math.floor(e/2);for(let n=-t;n<t;n++)for(let s=-t;s<t;s++)this.spawnGrassTile(n,s);console.log(`Generated ${this.groundTiles.length} ground tiles`)}loadHDR(e){return new Promise((t,n)=>{this.rgbeLoader.load(e,s=>{s.mapping=Os,t(s)},void 0,n)})}loadSkybox(e,t="webp"){return new Promise((n,s)=>{const i=new Ds;i.setPath(e);const o=[`px.${t}`,`nx.${t}`,`py.${t}`,`ny.${t}`,`pz.${t}`,`nz.${t}`];i.load(o,r=>{console.log("Skybox cubemap loaded:",t),n(r)},void 0,r=>{console.error("Failed to load skybox:",r),s(r)})})}createToonGradientMap(){const e=new Uint8Array([100,110,160,255,200,210,230,255,255,255,255,255]),t=new st(e,3,1,Pe);return t.needsUpdate=!0,t.minFilter=me,t.magFilter=me,t}createRoadGradientMap(){const e=new Uint8Array([5,5,8,255,10,10,15,255,20,20,28,255]),t=new st(e,3,1,Pe);return t.needsUpdate=!0,t.minFilter=me,t.magFilter=me,t}createWindowGradientMap(){const e=new Uint8Array([135,180,220,255,20,30,60,255,255,255,255,255]),t=new st(e,3,1,Pe);return t.needsUpdate=!0,t.minFilter=me,t.magFilter=me,t}createOutline(e,t=.015){const n=e.geometry.clone();n.attributes.normal||n.computeVertexNormals();const s=n.attributes.position,i=n.attributes.normal;if(s&&i){for(let a=0;a<s.count;a++)s.setX(a,s.getX(a)+i.getX(a)*t),s.setY(a,s.getY(a)+i.getY(a)*t),s.setZ(a,s.getZ(a)+i.getZ(a)*t);s.needsUpdate=!0}const o=new re({color:657946,side:Tt}),r=new E(n,o);return r.castShadow=!1,r.receiveShadow=!1,r}async loadModel(e){console.log(`Loading model: ${e}`),this.sharedGradientMap||(this.sharedGradientMap=this.createToonGradientMap());const t=this.sharedGradientMap;try{const s=(await new Promise((c,l)=>{this.gltfLoader.load(e,c,h=>console.log(`Loading progress: ${(h.loaded/h.total*100).toFixed(0)}%`),h=>{console.error("GLTF Load Error:",h),l(h)})})).scene,i=[];s.traverse(c=>{c.isMesh&&i.push(c)}),i.length===0&&(console.warn("  WARNING: No meshes found in model! Logging all nodes:"),s.traverse(c=>{console.log(`    Node: ${c.name||"(unnamed)"} type=${c.type}`)})),i.forEach(c=>{var w;const l=c.material;console.log(`  ${c.name}: color=${(w=l.color)==null?void 0:w.getHexString()}, map=${!!l.map}, vertexColors=${c.geometry.attributes.color?"YES":"NO"}`);const h=new Q({gradientMap:t,side:X});l.color&&h.color.copy(l.color),h.emissive.set(8947882),h.emissiveIntensity=.15,l.map&&(h.map=l.map),c.geometry.attributes.color&&(h.vertexColors=!0),c.geometry.computeVertexNormals(),c.material=h,c.castShadow=!0,c.receiveShadow=!0,c.geometry.computeBoundingBox();const d=c.geometry.boundingBox,g=new S;d.getSize(g);const y=Math.min(g.x,g.y,g.z),m=c.geometry.attributes.position.count;let p=.05;(y<.3||m<50)&&(p=.06),console.log(`    Outline: ${c.name} size=${y.toFixed(2)} polys=${m} thick=${p}`);const f=this.createOutline(c,p);c.add(f)});const o=new ve().setFromObject(s),r=o.getCenter(new S),a=o.getSize(new S);return s.position.x=-r.x,s.position.z=-r.z,s.position.y=-o.min.y,this.scene.add(s),console.log(`Model loaded: ${e}`),console.log(`  Size: ${a.x.toFixed(2)} x ${a.y.toFixed(2)} x ${a.z.toFixed(2)}`),s}catch(n){return console.error(`Failed to load model: ${e}`,n),null}}async loadCar(e){console.log(`Loading car: ${e}`),this.sharedGradientMap||(this.sharedGradientMap=this.createToonGradientMap());const t=this.sharedGradientMap;try{const s=(await new Promise((c,l)=>{this.gltfLoader.load(e,c,h=>console.log(`Loading progress: ${(h.loaded/h.total*100).toFixed(0)}%`),h=>{console.error("GLTF Load Error:",h),l(h)})})).scene,i=[];s.traverse(c=>{c.isMesh&&i.push(c)}),console.log("Car mesh hierarchy:"),i.forEach(c=>{const l=c.material,h=l.name||"unnamed",d=(c.name||"").toLowerCase(),g=d.includes("window")||d.includes("glass")||h.toLowerCase().includes("window"),y=d.includes("body"),m=d.includes("wheel");console.log(`  ${c.name} | mat: ${h} | map: ${!!l.map} | window:${g} body:${y} wheel:${m}`)}),i.forEach(c=>{const l=c.material,h=(l.name||"").toLowerCase(),d=(c.name||"").toLowerCase();c.geometry.computeVertexNormals();const g=h.includes("window"),y=d.includes("wheel")||d.includes("3dwheel"),m=(d.includes("body")||d.includes("car_body"))&&!g&&!y;let p;if(g?(p=new xe({color:1710638,metalness:.9,roughness:.1,side:X}),this.skyboxCubemap&&(p.envMap=this.skyboxCubemap,p.envMapIntensity=2),p.emissive=new te(657946),p.emissiveIntensity=.15,console.log(`    -> Window material with reflections: ${c.name}`)):m?(p=new xe({color:14737632,metalness:.3,roughness:.4,side:X}),this.skyboxCubemap&&(p.envMap=this.skyboxCubemap,p.envMapIntensity=.5),l.map?(p.map=l.map,console.log(`    -> Body with texture preserved: ${c.name}`)):console.log(`    -> Body (no texture): ${c.name}`)):y?(p=new Q({gradientMap:t,side:X}),l.color&&p.color.copy(l.color),l.map&&(p.map=l.map),p.emissive.set(3355443),p.emissiveIntensity=.15,console.log(`    -> Wheel material applied: ${c.name}`)):(p=new Q({gradientMap:t,side:X}),l.color&&p.color.copy(l.color),l.map&&(p.map=l.map),p.emissive.set(3355443),p.emissiveIntensity=.15),c.geometry.attributes.color&&(p.vertexColors=!0),c.material=p,c.castShadow=!0,c.receiveShadow=!1,m){const f=this.createCarOutline(c,.01);c.add(f);const _=/car_body_main\d*$/i.test(c.name)?15:40,b=this.createEdgeLines(c,_);c.add(b),console.log(`    -> Body outline + edges (${_}) added: ${c.name}`)}else if(y){const f=this.createCarOutline(c,.01);c.add(f),console.log(`    -> Wheel outline added: ${c.name}`)}});const o=new ve().setFromObject(s),r=o.getCenter(new S),a=o.getSize(new S);return s.position.x=-r.x,s.position.z=-r.z,s.position.y=-o.min.y,this.scene.add(s),console.log(`Car loaded: ${e}`),console.log(`  Size: ${a.x.toFixed(2)} x ${a.y.toFixed(2)} x ${a.z.toFixed(2)}`),s}catch(n){return console.error(`Failed to load car: ${e}`,n),null}}createEdgeLines(e,t=40){const n=new Ns(e.geometry,t),s=new We({color:1710638,linewidth:1,transparent:!0,opacity:.7,depthTest:!0,depthWrite:!0}),i=new Ut(n,s);return i.renderOrder=1,s.polygonOffset=!0,s.polygonOffsetFactor=-1,s.polygonOffsetUnits=-1,i}createCarOutline(e,t=.01){const n=e.geometry.clone();n.attributes.normal||n.computeVertexNormals();const s=n.attributes.position,i=n.attributes.normal;if(s&&i){for(let a=0;a<s.count;a++)s.setX(a,s.getX(a)+i.getX(a)*t),s.setY(a,s.getY(a)+i.getY(a)*t),s.setZ(a,s.getZ(a)+i.getZ(a)*t);s.needsUpdate=!0}const o=new re({color:657946,side:Tt,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),r=new E(n,o);return r.castShadow=!1,r.receiveShadow=!1,r}async loadTestRoad(){console.log("Loading test road..."),this.sharedGradientMap||(this.sharedGradientMap=this.createToonGradientMap());const e=new _e,t=await new Promise(n=>{e.load("/Road%20Pack/Textures%20compressed/Normal+AO/initialShadingGroup_Base_Color.png",s=>{s.colorSpace=Z,s.flipY=!1,console.log("Road texture loaded"),n(s)},void 0,s=>{console.warn("Failed to load road texture:",s),n(null)})});try{const s=(await new Promise((a,c)=>{this.gltfLoader.load("/Road%20Pack/Road%20Pieces/road_long.glb",a,void 0,c)})).scene;console.log("Road GLB loaded");const i=[];s.traverse(a=>{a.isMesh&&i.push(a)}),console.log(`Found ${i.length} road meshes`),i.forEach(a=>{const c=new Q({gradientMap:this.sharedGradientMap,map:t,color:16777215,side:X});a.material=c;const l=this.createOutline(a,.03);a.add(l)}),s.position.set(0,0,3),this.scene.add(s);const r=new ve().setFromObject(s).getSize(new S);console.log("Test road added - size:",r.x.toFixed(2),"x",r.y.toFixed(2),"x",r.z.toFixed(2))}catch(n){console.error("Failed to load test road:",n)}}async loadRoadTemplates(){console.log("Loading road templates...");const e=new _e;this.roadBaseColorMap=await new Promise(n=>{e.load("/Road%20Pack/Textures%20compressed/Normal+AO/initialShadingGroup_Base_Color.png",s=>{s.colorSpace=Z,s.flipY=!1,console.log("Road texture atlas loaded"),n(s)},void 0,()=>{console.warn("Failed to load road texture"),n(null)})});const t=["road_long","road_short","road_curve_wide","road_curve_tight"];for(const n of t){const s=await this.loadRoadTemplate(n);s&&(this.roadTemplates[n]=s)}console.log("Road templates loaded:",Object.keys(this.roadTemplates))}async loadRoadTemplate(e){const t=`/Road%20Pack/Road%20Pieces/${e}.glb`;this.sharedGradientMap||(this.sharedGradientMap=this.createToonGradientMap());try{const s=(await new Promise((a,c)=>{this.gltfLoader.load(t,a,void 0,c)})).scene,i=[];s.traverse(a=>{a.isMesh&&i.push(a)}),i.forEach(a=>{const c=new Q({gradientMap:this.sharedGradientMap,side:X});this.roadBaseColorMap?c.map=this.roadBaseColorMap:c.color.set(4868690),c.emissive.set(3355443),c.emissiveIntensity=.15,a.geometry.computeVertexNormals(),a.material=c,a.receiveShadow=!0,a.castShadow=!1;const l=this.createOutline(a,.03);a.add(l)}),s.visible=!1,this.scene.add(s);const r=new ve().setFromObject(s).getSize(new S);return console.log(`  ${e}: ${r.x.toFixed(1)} x ${r.z.toFixed(1)}`),s}catch(n){return console.error(`Failed to load road template: ${e}`,n),null}}findSocketOut(e){let t=null;return e.traverse(n=>{const s=n.name.toLowerCase();(s.includes("socket_out")||s.includes("socket")&&!s.includes("socket_in"))&&(t=n)}),t}findSocketIn(e){let t=null;return e.traverse(n=>{const s=n.name.toLowerCase();(s.includes("socket_in")||s.includes("origin")||s.includes("start"))&&(t=n)}),t}async spawnSpineAndBranchSystem3(){console.log("[System 3] Main Road with Side Streets..."),this.roadPieces.forEach(y=>this.scene.remove(y)),this.roadPieces=[];let t=12345;const n=()=>{t|=0,t=t+1831565813|0;let y=Math.imul(t^t>>>15,1|t);return y=y+Math.imul(y^y>>>7,61|y)^y,((y^y>>>14)>>>0)/4294967296},s={},i={Road1:L("Low%20Poly%20Env%20Exports/Road1.glb"),RoadX:L("Low%20Poly%20Env%20Exports/RoadX.glb")};for(const[y,m]of Object.entries(i))try{const f=(await new Promise((x,M)=>{this.gltfLoader.load(m,x,void 0,M)})).scene,w=[];f.traverse(x=>{x.isMesh&&w.push(x)});const _=this.createRoadBumpMap(),b=this.roadCubeCamera?this.roadCubeCamera.renderTarget.texture:this.skyboxCubemap;w.forEach(x=>{const M=x.material,v=new xe({color:16777215,roughness:.1,metalness:.38,side:X,bumpMap:_,bumpScale:.15,envMap:b,envMapIntensity:1.9});M.map&&(v.map=M.map),x.geometry.computeVertexNormals(),x.material=v,x.receiveShadow=!0,x.castShadow=!1,x.layers.set(1),x.layers.enable(0),this.roadMeshes||(this.roadMeshes=[]),this.roadMeshes.push(x);const T=this.createOutline(x,.03);x.add(T)}),console.log(`  ${y} sockets:`),f.traverse(x=>{x.name.toLowerCase().includes("socket")&&console.log(`    - ${x.name} at local (${x.position.x.toFixed(2)}, ${x.position.y.toFixed(2)}, ${x.position.z.toFixed(2)})`)}),f.visible=!1,this.scene.add(f),s[y]=f,console.log(`  Loaded: ${y}`)}catch(p){console.error(`Failed to load ${y}:`,p)}const o=(y,m)=>{let p=null;return y.traverse(f=>{f.name.toLowerCase()===m.toLowerCase()&&(p=f)}),p||y.traverse(f=>{f.name.toLowerCase().includes(m.toLowerCase())&&(p=f)}),p},r=(y,m,p)=>{const f=s[y];if(!f)return null;const w=f.clone(!0);return w.visible=!0,w.traverse(_=>{_.visible=!0}),w.position.copy(m),w.quaternion.copy(p),this.scene.add(w),w.updateMatrixWorld(!0),this.roadPieces.push(w),w},a=(y,m)=>{const p=o(y,m);if(!p)return null;p.updateMatrixWorld(!0);const f=new S,w=new H;return p.getWorldPosition(f),p.getWorldQuaternion(w),{pos:f,quat:w}},c=[],l=20,h=.2;let d=new S(0,0,0),g=new H;console.log(`  Building main spine (${l} pieces)...`);for(let y=0;y<l;y++){const m=y>0&&y<l-1&&n()<h,p=m?"RoadX":"Road1",f=r(p,d,g);if(!f){console.error(`  Failed to spawn ${p} at piece ${y}`);break}if(console.log(`  Spine[${y}]: ${p} at (${d.x.toFixed(1)}, ${d.z.toFixed(1)})`),m){const _=a(f,"socket_left"),b=a(f,"socket_right");_&&(c.push({..._,side:"left",length:5}),console.log("    -> Queued left branch")),b&&(c.push({...b,side:"right",length:5}),console.log("    -> Queued right branch"))}const w=a(f,"socket_out");if(w)d=w.pos,g=w.quat;else{console.warn(`  No socket_out on ${p}, stopping spine`);break}}console.log(`  Main spine complete: ${this.roadPieces.length} pieces`),console.log(`  Spawning ${c.length} side streets...`);for(const y of c){let m=y.pos.clone(),p=y.quat.clone();console.log(`  Branch (${y.side}): starting at (${m.x.toFixed(1)}, ${m.z.toFixed(1)})`);for(let f=0;f<y.length;f++){const w=r("Road1",m,p);if(!w)break;const _=a(w,"socket_out");if(_)m=_.pos,p=_.quat;else break}}console.log(`[System 3] Complete: ${this.roadPieces.length} total pieces, ${c.length} side streets`)}async spawnRoadNetworkSystem2(e=30){console.log(`[System 2] Generating road network with ${e} pieces...`),this.roadPieces.forEach(m=>this.scene.remove(m)),this.roadPieces=[],this.occupiedCells.clear();const t={},n={Road1:L("Low%20Poly%20Env%20Exports/Road1.glb"),RoadX:L("Low%20Poly%20Env%20Exports/RoadX.glb")};for(const[m,p]of Object.entries(n))try{const w=(await new Promise((b,x)=>{this.gltfLoader.load(p,b,void 0,x)})).scene,_=[];w.traverse(b=>{b.isMesh&&_.push(b)}),_.forEach(b=>{const x=new Q({gradientMap:this.sharedGradientMap,side:X});b.material.color&&x.color.copy(b.material.color),x.emissive.set(2236962),x.emissiveIntensity=.1,b.geometry.computeVertexNormals(),b.material=x,b.receiveShadow=!0,b.castShadow=!1;const M=this.createOutline(b,.03);b.add(M)}),console.log(`  ${m} sockets:`),w.traverse(b=>{b.name.toLowerCase().includes("socket")&&console.log(`    - ${b.name} at (${b.position.x.toFixed(2)}, ${b.position.y.toFixed(2)}, ${b.position.z.toFixed(2)})`)}),w.visible=!1,this.scene.add(w),t[m]=w,console.log(`  Loaded: ${m}`)}catch(f){console.error(`Failed to load ${m}:`,f)}const s=m=>{const p=[];return m.traverse(f=>{const w=f.name.toLowerCase();w.includes("socket_out")?p.push({node:f,type:"out"}):w.includes("socket_right")?p.push({node:f,type:"right"}):w.includes("socket_left")?p.push({node:f,type:"left"}):w.includes("socket")&&!w.includes("in")&&p.push({node:f,type:"out"})}),p},i=[],o=m=>{const p=[],f=new S;m.getWorldPosition(f),p.push({x:f.x,z:f.z});const w=s(m);for(const{node:_}of w){const b=new S;_.getWorldPosition(b);const x=5;for(let M=1;M<=x;M++){const v=M/x,T=f.clone().lerp(b,v);p.push({x:T.x,z:T.z})}}return p},r=(m,p=2)=>{for(const f of m){const w=this.cellKey(f.x,f.z);if(this.occupiedCells.has(w))return!0}return!1},a=m=>{for(const p of m)this.occupiedCells.add(this.cellKey(p.x,p.z))},c=t.Road1.clone(!0);c.visible=!0,c.traverse(m=>{m.visible=!0}),c.position.set(0,0,5),this.scene.add(c),this.roadPieces.push(c),c.updateMatrixWorld(!0);const l=o(c);a(l);const h=s(c);for(const m of h){m.node.updateMatrixWorld(!0);const p=new S,f=new H;m.node.getWorldPosition(p),m.node.getWorldQuaternion(f),i.push({pos:p.clone(),quat:f.clone(),type:m.type})}console.log(`  First piece placed with ${i.length} open sockets`);let d=1,g=0;const y=e*3;for(;d<e&&i.length>0&&g<y;){g++;const m=Math.floor(Math.random()*i.length),{pos:p,quat:f,type:w}=i[m],_=Math.random()<.8?"Road1":"RoadX",b=t[_];if(!b)continue;const x=b.clone(!0);x.visible=!0,x.traverse(T=>{T.visible=!0}),x.position.copy(p),x.quaternion.copy(f),this.scene.add(x),x.updateMatrixWorld(!0);const M=o(x);if(r(M)){this.scene.remove(x),i.splice(m,1);continue}a(M),this.roadPieces.push(x),i.splice(m,1);const v=s(x);for(const T of v){T.node.updateMatrixWorld(!0);const A=new S,P=new H;T.node.getWorldPosition(A),T.node.getWorldQuaternion(P),i.push({pos:A.clone(),quat:P.clone(),type:T.type})}d++}console.log(`[System 2] Network generated with ${this.roadPieces.length} pieces, ${i.length} open sockets remaining`)}async spawnProceduralRoadSystem1(e=50){console.log(`Procedurally generating ${e} road pieces...`),this.roadPieces.forEach(m=>this.scene.remove(m)),this.roadPieces=[],this.occupiedCells.clear();let t=0,n=0,s=99;const i=2,o=1,r={road_long:{type:"straight"},road_short:{type:"straight"},road_curve_wide:{type:"curve"},road_curve_tight:{type:"curve"}},a={},c=new _e,l=await new Promise(m=>{c.load("/Road%20Pack/Textures%20compressed/Normal+AO/initialShadingGroup_Base_Color.png",p=>{p.colorSpace=Z,p.flipY=!1,m(p)},void 0,()=>m(null))});for(const m of Object.keys(r)){const p=`/Road%20Pack/Road%20Pieces/${m}.glb`;try{const w=(await new Promise((b,x)=>{this.gltfLoader.load(p,b,void 0,x)})).scene,_=[];w.traverse(b=>{b.isMesh&&_.push(b)}),_.forEach(b=>{const x=new Q({gradientMap:this.sharedGradientMap,side:X});l&&(x.map=l),x.emissive.set(2236962),x.emissiveIntensity=.1,b.geometry.computeVertexNormals(),b.material=x,b.receiveShadow=!0,b.castShadow=!1;const M=this.createOutline(b,.03);b.add(M)}),w.visible=!1,this.scene.add(w),a[m]=w,console.log(`  Loaded: ${m}`)}catch(f){console.error(`Failed to load ${m}:`,f)}}const h=[],d=m=>{const p=[],f=new S;m.getWorldPosition(f);const w=this.findSocketOut(m);if(!w)return[{x:f.x,z:f.z}];const _=new S;w.getWorldPosition(_);const x=_.clone().sub(f).length(),M=Math.max(Math.ceil(x/1),1);for(let v=0;v<=M;v++){const T=v/M,A=f.clone().lerp(_,T);p.push({x:A.x,z:A.z})}return p},g=(m,p)=>{for(const f of m){const w=this.cellKey(f.x,f.z);if(this.occupiedCells.has(w)&&!p.has(w))return!0}return!1},y=m=>m.filter(({key:p,mirror:f})=>r[p].type==="curve"?!(s<o||(f?-1:1)===t&&n>=i):!0);for(let m=0;m<e;m++){let p=!1;const f=new Set;for(const _ of h)for(const b of _)f.add(b);let w=[];if(m<3)for(const _ of Object.keys(r))r[_].type==="straight"&&w.push({key:_,mirror:!1});else for(const _ of Object.keys(r))w.push({key:_,mirror:!1}),r[_].type==="curve"&&w.push({key:_,mirror:!0});w=y(w);for(let _=w.length-1;_>0;_--){const b=Math.floor(Math.random()*(_+1));[w[_],w[b]]=[w[b],w[_]]}for(const{key:_,mirror:b}of w){const x=a[_];if(!x)continue;const M=x.clone(!0);if(M.visible=!0,M.traverse(P=>{P.visible=!0}),M.scale.set(2,2,2),b&&(M.scale.x*=-1),this.roadPieces.length===0)M.position.set(0,0,5),M.quaternion.identity();else{const P=this.roadPieces[this.roadPieces.length-1],k=this.findSocketOut(P);if(k){P.updateMatrixWorld(!0);const G=new S,F=new H;k.getWorldPosition(G),k.getWorldQuaternion(F),M.position.copy(G),M.quaternion.copy(F)}}this.scene.add(M),M.updateMatrixWorld(!0);const v=d(M);if(g(v,f)){this.scene.remove(M);continue}const T=new Set;for(const P of v){const k=this.cellKey(P.x,P.z);T.add(k),this.occupiedCells.add(k)}if(h.push(T),h.length>3&&h.shift(),this.roadPieces.push(M),r[_].type==="curve"){const P=b?-1:1;P===t?n++:n=1,t=P,s=0}else s++;p=!0;break}if(!p){console.warn(`[Road] Dead end at segment ${m}. Stopping.`);break}}console.log(`Procedural road generated with ${this.roadPieces.length} pieces`)}async spawnConnectedRoads(e,t=10){console.log(`Spawning ${t} connected road pieces from ${e}...`),this.sharedGradientMap||(this.sharedGradientMap=this.createToonGradientMap());let n;try{n=(await new Promise((h,d)=>{this.gltfLoader.load(e,h,void 0,d)})).scene}catch(l){console.error("Failed to load road template:",l);return}const s=new _e,i=await new Promise(l=>{s.load("/Road%20Pack/Textures%20compressed/Normal+AO/initialShadingGroup_Base_Color.png",h=>{h.colorSpace=Z,h.flipY=!1,console.log("Road texture loaded"),l(h)},void 0,()=>{console.warn("Failed to load road texture"),l(null)})}),o=[];n.traverse(l=>{l.isMesh&&o.push(l)}),o.forEach(l=>{const h=new Q({gradientMap:this.sharedGradientMap,side:X});i?h.map=i:l.material.color&&h.color.copy(l.material.color),h.emissive.set(2236962),h.emissiveIntensity=.1,l.geometry.computeVertexNormals(),l.material=h,l.receiveShadow=!0,l.castShadow=!1;const d=this.createOutline(l,.03);l.add(d)}),console.log("Road template children:"),n.traverse(l=>{l!==n&&console.log(`  - ${l.name} (${l.type})`)});const r=this.findSocketOut(n);r?console.log(`  socket_out local pos: (${r.position.x.toFixed(2)}, ${r.position.y.toFixed(2)}, ${r.position.z.toFixed(2)})`):console.warn("No socket_out found in road template - using bounding box");let a=new S(0,0,5),c=new H;for(let l=0;l<t;l++){const h=n.clone(!0);h.position.copy(a),h.quaternion.copy(c),this.scene.add(h),this.registerSelectable(h,`road_${l}`),h.updateMatrixWorld(!0);const d=this.findSocketOut(h);d?(d.getWorldPosition(a),d.getWorldQuaternion(c),console.log(`  Road ${l} socket_out world: (${a.x.toFixed(2)}, ${a.y.toFixed(2)}, ${a.z.toFixed(2)})`)):a.z+=5}console.log(`Spawned ${t} connected road pieces`)}getSocketTransform(e){const t=this.findSocketOut(e);if(!t)return console.warn("No socket_out found in piece"),null;t.updateMatrixWorld(!0);const n=new S,s=new H;return t.getWorldPosition(n),t.getWorldQuaternion(s),{position:n,quaternion:s}}spawnRoadPiece(e,t,n){const s=this.roadTemplates[e];if(!s)return console.error(`Road template not found: ${e}`),null;const i=s.clone(!0);return i.visible=!0,i.traverse(o=>{o.visible=!0}),i.scale.set(2,2,2),i.position.copy(t),i.quaternion.copy(n),this.scene.add(i),this.roadPieces.push(i),i}cellKey(e,t){const n=Math.round(e/this.GRID_CELL_SIZE),s=Math.round(t/this.GRID_CELL_SIZE);return`${n},${s}`}sampleRoadCells(e){const t=[],n=this.findSocketOut(e);if(!n)return t;const s=new S;e.getWorldPosition(s),n.updateMatrixWorld(!0);const i=new S;n.getWorldPosition(i);const o=s.distanceTo(i),r=Math.max(1,Math.ceil(o));for(let a=0;a<=r;a++){const c=a/r,l=s.x+(i.x-s.x)*c,h=s.z+(i.z-s.z)*c;t.push(this.cellKey(l,h))}return t}checkCollision(e,t=new Set){for(const n of e)if(this.occupiedCells.has(n)&&!t.has(n))return!0;return!1}trySpawnRoadPiece(e,t,n,s=null){const i=this.roadTemplates[e];if(!i)return null;const o=i.clone(!0);o.visible=!0,o.traverse(d=>{d.visible=!0}),o.scale.set(2,2,2),o.position.copy(t),o.quaternion.copy(n),this.scene.add(o),o.updateMatrixWorld(!0);const r=this.sampleRoadCells(o),a=new Set,c=Math.min(2,this.roadPieces.length);for(let d=this.roadPieces.length-c;d<this.roadPieces.length;d++)d>=0&&this.sampleRoadCells(this.roadPieces[d]).forEach(y=>a.add(y));let l=!1;for(const d of r)if(this.occupiedCells.has(d)&&!a.has(d)){l=!0;break}return l?(this.scene.remove(o),null):(this.sampleRoadWorldGridCells(o).forEach(({gridX:d,gridZ:g})=>{const y=`${d},${g}`,m=this.worldGrid.get(y);m&&m.type==="grass"&&this.removeTileAt(d,g)}),r.forEach(d=>this.occupiedCells.add(d)),this.roadPieces.push(o),o.position.y+=.001,o)}sampleRoadWorldGridCells(e){const t=[],n=this.findSocketOut(e);if(!n)return t;const s=new S;e.getWorldPosition(s),n.updateMatrixWorld(!0);const i=new S;n.getWorldPosition(i);const o=s.distanceTo(i),r=Math.max(1,Math.ceil(o/2));for(let a=0;a<=r;a++){const c=a/r,l=s.x+(i.x-s.x)*c,h=s.z+(i.z-s.z)*c,d=Math.round(l/this.TILE_SIZE),g=Math.round(h/this.TILE_SIZE);t.some(m=>m.gridX===d&&m.gridZ===g)||t.push({gridX:d,gridZ:g})}return t}async generateRoad(e=10){console.log(`Generating ${e} road pieces...`),this.roadPieces.forEach(o=>this.scene.remove(o)),this.roadPieces=[],this.occupiedCells.clear();let t=new S(0,0,0),n=new H,s=0;const i=5;for(let o=0;o<e&&s<i;o++){const r=s>0?["road_long","road_short"]:["road_long","road_short","road_curve_wide","road_curve_tight"];let a=null;for(const l of this.shuffleArray([...r]))if(a=this.trySpawnRoadPiece(l,t,n),a)break;if(!a){s++,console.warn(`Road piece ${o} collision - attempt ${s}/${i}`);continue}s=0;const c=this.getSocketTransform(a);c&&(t=c.position,n=c.quaternion)}console.log(`Generated ${this.roadPieces.length} road pieces`)}shuffleArray(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}async loadRoad(e){console.log(`Loading road: ${e}`),this.sharedGradientMap||(this.sharedGradientMap=this.createToonGradientMap());const t=this.sharedGradientMap;if(!this.roadBaseColorMap){const n=new _e;this.roadBaseColorMap=await new Promise(s=>{n.load("/Road%20Pack/Textures%20compressed/Normal+AO/initialShadingGroup_Base_Color.png",i=>{i.colorSpace=Z,i.flipY=!1,console.log("Road base color texture atlas loaded"),s(i)},void 0,()=>{console.warn("Failed to load road texture, using fallback color"),s(null)})})}try{const s=(await new Promise((i,o)=>{this.gltfLoader.load(e,i,void 0,o)})).scene;return s.traverse(i=>{if(i.isMesh){const o=i.material,r=new Q({gradientMap:t,side:X});this.roadBaseColorMap?r.map=this.roadBaseColorMap:o.color&&r.color.copy(o.color),r.emissive.set(3355443),r.emissiveIntensity=.15,i.geometry.computeVertexNormals(),i.material=r,i.receiveShadow=!0,i.castShadow=!1,console.log(`  Road mesh: ${i.name}, textured: ${!!this.roadBaseColorMap}`)}}),this.scene.add(s),console.log(`Road loaded: ${e}`),s}catch(n){return console.error(`Failed to load road: ${e}`,n),null}}toggleGrid(){this.gridHelper.visible=!this.gridHelper.visible}toggleUI(){const e=[document.getElementById("controls-hint"),document.getElementById("scene-menu"),document.getElementById("building-menu")];this.uiHidden=!this.uiHidden,e.forEach(t=>{t&&(t.style.display=this.uiHidden?"none":"")}),this.uiHidden&&this.transformControls?this.transformControls.visible=!1:this.transformControls&&(this.transformControls.visible=!0),console.log(this.uiHidden?"UI hidden (press H to show)":"UI visible")}preciseZoom(e){const t=new S;this.camera.getWorldDirection(t);const n=t.multiplyScalar(e);this.camera.position.add(n),this.controls.target.add(n)}resetCameraToOrigin(){const e=new S(0,2,0),t=new S(8,2,12),n=300,s=performance.now(),i=this.controls.target.clone(),o=this.camera.position.clone(),r=()=>{const a=performance.now()-s,c=Math.min(a/n,1),l=1-Math.pow(1-c,3);this.controls.target.lerpVectors(i,e,l),this.camera.position.lerpVectors(o,t,l),c<1&&requestAnimationFrame(r)};r(),console.log("Camera reset to origin")}onResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}showError(e){console.error(e);const t=document.createElement("div");t.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:red;color:white;padding:20px;z-index:9999;max-width:80%;word-wrap:break-word;",t.textContent=e,document.body.appendChild(t)}hideLoadingScreen(){this.loadingScreen.classList.add("hidden"),setTimeout(()=>{this.loadingScreen.style.display="none"},500)}animate(){requestAnimationFrame(()=>this.animate()),this.controls.update(),this.renderer.render(this.scene,this.camera)}}const Zt=new Vn;Zt.init().catch(console.error);window.viewer=Zt;
//# sourceMappingURL=index-BtLlsPuW.js.map
